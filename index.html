<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de bankroll</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        /* CORRECTION DES ONGLETS POUR MOBILE */
        .tabs-container {
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .tabs { 
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            white-space: nowrap;
            -webkit-overflow-scrolling: touch; /* iOS smooth scrolling */
        }
        .tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        .tab-button { 
            flex: 0 0 auto; /* Emp√™che le flex-shrink */
            padding: 18px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            min-width: 140px; /* Largeur minimale pour √™tre cliquable sur mobile */
        }
        .tab-button:hover { background: #f9fafb; color: #3b82f6; }
        .tab-button.active { color: #3b82f6; border-bottom-color: #3b82f6; background: #eff6ff; }
        
        /* Indicateur de scroll pour mobile */
        .scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent, white);
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        .scroll-indicator::after {
            content: '‚Ä∫';
            font-size: 1.5rem;
            color: #3b82f6;
            font-weight: bold;
        }
        
        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        
        /* Ajustements pour mobile */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .tab-content { padding: 15px; }
            .card { padding: 20px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            .tabs { padding-bottom: 5px; } /* Espace pour le scroll */
            .scroll-indicator { display: flex; }
        }
        
        @media (max-width: 480px) {
            .tab-button { 
                padding: 15px 16px;
                font-size: 0.9rem;
                min-width: 120px;
            }
            .header h1 { font-size: 1.8rem; }
        }

        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .card-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
        .card-description { color: #6b7280; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; position: relative; }
        label { font-weight: 600; margin-bottom: 8px; color: #374151; }
        input, select { padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-info { background: #06b6d4; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.875rem; }
        .btn-block { width: 100%; }
        .gain-display { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 15px; border-radius: 8px; font-size: 1.5rem; font-weight: 700; text-align: center; }
        .autocomplete-container { position: relative; }
        .autocomplete-results { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #3b82f6; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .autocomplete-results.active { display: block; }
        .autocomplete-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .autocomplete-item:hover { background: #eff6ff; }
        .match-info { font-weight: 600; color: #1f2937; }
        .match-meta { font-size: 0.875rem; color: #6b7280; margin-top: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th { background: #f9fafb; padding: 12px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        td { padding: 12px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        tr:hover { background: #f9fafb; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fed7aa; color: #9a3412; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f3f4f6; color: #374151; }
        .bookmaker-list { display: grid; gap: 15px; margin-bottom: 20px; }
        .bookmaker-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb; }
        .bookmaker-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .bookmaker-balance { color: #6b7280; }
        .bookmaker-current { font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin-right: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 25px; border-radius: 12px; }
        .stat-card.green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .stat-label { font-size: 0.95rem; opacity: 0.9; margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .action-buttons { display: flex; gap: 4px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .edit-mode-banner { background: #fef3c7; color: #92400e; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; text-align: center; }
        .reset-zone { margin-top: 30px; padding-top: 30px; border-top: 2px solid #fee2e2; }
        .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tipster-card { background: #f9fafb; padding: 20px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; }
        .tipster-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .tipster-card.selected { border-color: #3b82f6; background: #eff6ff; }
        .tipster-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tipster-name { font-size: 1.3rem; font-weight: 700; color: #1f2937; }
        .tipster-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9rem; }
        .tipster-stat { text-align: center; }
        .tipster-stat-value { font-weight: 700; color: #3b82f6; }
        .tipster-stat-label { color: #6b7280; font-size: 0.85rem; }
        .sport-icon { width: 20px; height: 20px; display: inline-block; text-align: center; font-weight: bold; margin-right: 5px; }
        
        /* Styles pour Firebase Auth */
        .auth-container { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .user-info { background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .sync-status { position: fixed; top: 20px; right: 20px; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 0.9rem; }
        .sync-status.syncing { background: #fef3c7; color: #92400e; }
        .sync-status.synced { background: #dcfce7; color: #166534; }
        .sync-status.error { background: #fee2e2; color: #991b1b; }
        .offline-mode { background: #fef3c7; color: #92400e; }
        
        /* Loader pour mobile */
        .mobile-loader {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .mobile-loader.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barre de statut de synchronisation -->
        <div class="sync-status" id="syncStatus" style="display: none;">
            üîÑ Synchronisation...
        </div>

        <div class="header">
            <h1>üí∞ Suivi de bankroll</h1>
            <p>G√©rez vos paris sportifs et suivez vos performances</p>
        </div>

        <!-- Loader pour mobile -->
        <div class="mobile-loader" id="mobileLoader">
            <div style="font-size: 2rem; margin-bottom: 20px;">‚è≥</div>
            <h3>Chargement des donn√©es...</h3>
            <p>Veuillez patienter</p>
        </div>

        <!-- Section Authentification -->
        <div class="auth-container" id="authContainer">
            <h2>üîê Connexion</h2>
            <p>Connectez-vous pour synchroniser vos donn√©es sur tous vos appareils</p>
            <div class="form-grid" style="max-width: 400px; margin: 20px auto;">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="authEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="authPassword" placeholder="Votre mot de passe">
                </div>
            </div>
            <button class="btn btn-primary" onclick="login()">Se connecter</button>
            <button class="btn btn-secondary" onclick="signup()">Cr√©er un compte</button>
            <div style="margin-top: 15px; font-size: 0.9rem; color: #6b7280;">
                <p>Ou utilisez un compte anonyme :</p>
                <button class="btn btn-info btn-sm" onclick="loginAnonymously()">Utiliser sans compte</button>
            </div>
        </div>

        <!-- Info utilisateur connect√© -->
        <div class="user-info" id="userInfo" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Connect√© en tant que :</strong> 
                    <span id="userEmail"></span>
                    <span id="userAnonymous" style="font-style: italic; color: #6b7280;"></span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <!-- Le reste de votre application - CORRIG√â POUR MOBILE -->
        <div class="tabs-container" id="appContent" style="display: none;">
            <div class="tabs" id="mainTabs">
                <button class="tab-button active" data-tab="enregistrer">Enregistrer</button>
                <button class="tab-button" data-tab="suivi-operations">Suivi</button>
                <button class="tab-button" data-tab="tipsters">Tipsters</button>
                <button class="tab-button" data-tab="bookmakers">Bookmakers</button>
                <button class="tab-button" data-tab="statistiques">Stats</button>
                <button class="tab-button" data-tab="outils">Outils</button>
                <button class="tab-button" data-tab="reglages">R√©glages</button>
            </div>
            <div class="scroll-indicator" id="scrollIndicator"></div>
        </div>
        
        <!-- Onglet Enregistrer -->
        <div class="tab-content" id="enregistrer">
            <div class="card">
                <div id="editModeBanner" class="edit-mode-banner" style="display: none;">
                    üìù Mode modification activ√© - Les donn√©es actuelles sont conserv√©es
                </div>
                <h2 class="card-title">Enregistrer une op√©ration</h2>
                <p class="card-description">Ajoutez un nouveau pari, d√©p√¥t, retrait ou frais</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Type d'op√©ration</label>
                        <select id="operationType">
                            <option value="Pari">Pari</option>
                            <option value="D√©p√¥t">D√©p√¥t</option>
                            <option value="Retrait">Retrait</option>
                            <option value="Frais">Frais</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bookmaker</label>
                        <select id="operationBookmaker"><option value="">S√©lectionner un bookmaker</option></select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="dateOperation" value="">
                    </div>
                    <div class="form-group">
                        <label>Heure</label>
                        <input type="time" id="heureOperation" value="">
                    </div>
                </div>
                <div id="pariFields">
                    <div class="form-group">
                        <label>Tipster (optionnel)</label>
                        <select id="operationTipster">
                            <option value="">Aucun / Personnel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rechercher un match</label>
                        <div class="autocomplete-container">
                            <input type="text" id="matchSearch" placeholder="Tapez le nom d'une √©quipe (ex: Barnsley, PSG...)">
                            <div class="autocomplete-results" id="autocompleteResults"></div>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Sport</label>
                            <input type="text" id="sport" placeholder="Football, Tennis...">
                        </div>
                        <div class="form-group">
                            <label>Match</label>
                            <input type="text" id="match" placeholder="PSG vs OM">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>√âquipe / S√©lection</label><input type="text" id="selection" placeholder="PSG"></div>
                        <div class="form-group">
                            <label>Type de pari</label>
                            <select id="typePari">
                                <option value="Simple">Simple</option>
                                <option value="Multiple">Multiple</option>
                                <option value="Score exact">Score exact</option>
                                <option value="Points">Points</option>
                                <option value="Marqueur">Marqueur</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Mise (‚Ç¨)</label><input type="number" id="mise" step="0.01" placeholder="0.00"></div>
                        <div class="form-group"><label>C√¥te</label><input type="number" id="cote" step="0.01" placeholder="1.50"></div>
                        <div class="form-group"><label>Gain net (‚Ç¨)</label><div class="gain-display" id="gainPotentiel">0.00 ‚Ç¨</div></div>
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="statut">
                            <option value="En cours">En cours</option>
                            <option value="Gagn√©">Gagn√©</option>
                            <option value="Perdu">Perdu</option>
                            <option value="Rembours√©">Rembours√©</option>
                        </select>
                    </div>
                </div>
                <div id="depotRetraitFields" style="display: none;">
                    <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" id="montant" step="0.01" placeholder="0.00"></div>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveOperation()">Enregistrer</button>
                <button id="cancelEditBtn" class="btn btn-secondary btn-block" onclick="cancelEdit()" style="display: none; margin-top: 10px;">Annuler la modification</button>
            </div>
        </div>
        
        <!-- Onglet Suivi des op√©rations -->
        <div class="tab-content" id="suivi-operations">
            <div class="card">
                <h2 class="card-title">Suivi des op√©rations</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date/Heure</th>
                                <th>Type</th>
                                <th>Bookmaker</th>
                                <th>Sport</th>
                                <th>Match</th>
                                <th>√âquipe/S√©lection</th>
                                <th>Type pari</th>
                                <th>Tipster</th>
                                <th>Mise</th>
                                <th>C√¥te</th>
                                <th>Statut</th>
                                <th>R√©sultat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTableBody">
                            <tr><td colspan="13" style="text-align: center; color: #9ca3af; padding: 40px;">Aucune op√©ration</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Onglet Tipsters -->
        <div class="tab-content" id="tipsters">
            <div class="card">
                <h2 class="card-title">Tipsters</h2>
                <p class="card-description">G√©rez vos tipsters et suivez leurs performances</p>
                <div id="tipsterList"></div>
                <button class="btn btn-primary" onclick="showTipsterForm()">Ajouter un tipster</button>
                <div id="tipsterFormContainer" style="display: none; margin-top: 20px;">
                    <h3 id="tipsterFormTitle">Nouveau Tipster</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Nom du tipster</label><input type="text" id="tipsterNom"></div>
                        <div class="form-group"><label>Description (optionnel)</label><input type="text" id="tipsterDescription" placeholder="Ex: Twitter @pseudo"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveTipster()">Enregistrer</button>
                    <button class="btn btn-secondary" onclick="cancelTipsterForm()">Annuler</button>
                </div>
                <div id="tipsterDetailsContainer" style="display: none; margin-top: 30px;">
                    <h3 id="tipsterDetailsTitle"></h3>
                    <div class="stats-grid" id="tipsterDetailsStats"></div>
                    <button class="btn btn-secondary" onclick="closeTipsterDetails()">Retour</button>
                </div>
            </div>
        </div>
        
        <!-- Onglet Bookmakers -->
        <div class="tab-content" id="bookmakers">
            <div class="card">
                <h2 class="card-title">Bookmakers</h2>
                <div class="bookmaker-list" id="bookmakerList"></div>
                <button class="btn btn-primary" onclick="showBookmakerForm()">Ajouter un bookmaker</button>
                <div id="bookmakerFormContainer" style="display: none; margin-top: 20px;">
                    <h3 id="bookmakerFormTitle">Nouveau Bookmaker</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Nom</label><input type="text" id="bookmakerNom"></div>
                        <div class="form-group"><label>Solde initial (‚Ç¨)</label><input type="number" id="bookmakerSolde" step="0.01"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveBookmaker()">Enregistrer</button>
                    <button class="btn btn-secondary" onclick="cancelBookmakerForm()">Annuler</button>
                </div>
            </div>
        </div>
        
        <!-- Onglet Statistiques -->
        <div class="tab-content" id="statistiques">
            <div class="card">
                <h2 class="card-title">Statistiques</h2>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
        
        <!-- Onglet Outils -->
        <div class="tab-content" id="outils">
            <div class="card">
                <h2 class="card-title">üõ†Ô∏è Outils</h2>
                <p class="card-description">Section en construction - Bient√¥t de nouvelles fonctionnalit√©s !</p>
                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üîß</div>
                    <h3 style="margin-bottom: 10px;">Fonctionnalit√©s √† venir</h3>
                    <p>Nous travaillons sur de nouveaux outils pour am√©liorer votre exp√©rience.</p>
                </div>
            </div>
        </div>
        
        <!-- Onglet R√©glages -->
        <div class="tab-content" id="reglages">
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è R√©glages</h2>
                <p class="card-description">G√©rez vos donn√©es et param√®tres</p>
                
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportData()">üì• Exporter les donn√©es</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì§ Importer les donn√©es</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
                
                <div class="reset-zone">
                    <h3 style="color: #dc2626; margin-bottom: 15px;">‚ö†Ô∏è Zone dangereuse</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">Cette action supprimera toutes vos donn√©es de mani√®re irr√©versible.</p>
                    <button class="btn btn-danger" onclick="resetApp()">üóëÔ∏è R√©initialiser l'application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cash-out -->
    <div class="modal" id="cashoutModal">
        <div class="modal-content">
            <div class="modal-header">üí∞ Cash-out</div>
            <div class="form-group">
                <label>Montant du cash-out (‚Ç¨)</label>
                <input type="number" id="cashoutAmount" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="confirmCashout()">Valider</button>
                <button class="btn btn-secondary" onclick="closeCashoutModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION FIREBASE SIMPLIFI√âE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDbtGDuOVE4lYkVtLjZ0AnrpbWVnwcdvZI",
            authDomain: "bankroll-suivi.firebaseapp.com",
            databaseURL: "https://bankroll-suivi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bankroll-suivi",
            storageBucket: "bankroll-suivi.firebasestorage.app",
            messagingSenderId: "632546496211",
            appId: "1:632546496211:web:25375f3e496c4a43490e26"
        };

        // Variables globales
        let bookmakers = [];
        let operations = [];
        let tipsters = [];
        let searchTimeout = null;
        let currentCashoutId = null;
        let editingOperationId = null;
        let editingTipsterId = null;
        let editingBookmakerId = null;
        let isSyncing = false;
        let currentUser = null;
        let auth = null;
        let database = null;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const mockMatches = [
            {sport: 'Football', home: 'Barnsley', away: 'Lincoln', date: '2025-11-15', time: '20:00'},
            {sport: 'Football', home: 'PSG', away: 'OM', date: '2025-11-16', time: '21:00'},
            {sport: 'Football', home: 'Real Madrid', away: 'Barcelona', date: '2025-11-17', time: '20:00'},
            {sport: 'Football', home: 'Manchester United', away: 'Liverpool', date: '2025-11-18', time: '17:30'},
            {sport: 'Football', home: 'Bayern', away: 'Dortmund', date: '2025-11-19', time: '18:30'},
            {sport: 'Football', home: 'Arsenal', away: 'Chelsea', date: '2025-11-22', time: '16:00'}
        ];

        const sportIcons = {
            'Football': '‚öΩ', 'Basketball': 'üèÄ', 'Tennis': 'üéæ', 'Rugby': 'üèâ',
            'Hockey': 'üèí', 'Volley': 'üèê', 'F1': 'üèéÔ∏è', 'Baseball': '‚öæ',
            'Golf': '‚õ≥', 'Boxe': 'ü•ä'
        };

        // === INITIALISATION CORRIG√âE ===
        function initializeApp() {
            console.log('D√©marrage sur:', isMobile ? 'Mobile' : 'Desktop');
            
            // Cacher TOUS les contenus au d√©but
            hideAllContent();
            
            try {
                // Initialiser Firebase
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                console.log('Firebase initialis√© avec succ√®s');
                
                // Configurer l'√©couteur d'authentification
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        console.log('Utilisateur connect√©:', user.email);
                        showAppUI(user);
                    } else {
                        console.log('Aucun utilisateur connect√©');
                        showAuthUI();
                    }
                }, (error) => {
                    console.error('Erreur auth:', error);
                    showLocalMode();
                });
                
            } catch (error) {
                console.error('Erreur initialisation Firebase:', error);
                showLocalMode();
            }
        }

        function hideAllContent() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('mobileLoader').style.display = 'none';
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
        }

        // === MODE LOCAL SANS FIREBASE ===
        function showLocalMode() {
            console.log('Mode local activ√©');
            
            hideAllContent();
            loadDataFromLocalStorage();
            updateUI();
            
            // Afficher directement l'application
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('enregistrer').style.display = 'block';
            
            showSyncStatus('üì± Mode local - Donn√©es locales', 'synced');
        }

        function showAuthUI() {
            hideAllContent();
            document.getElementById('authContainer').style.display = 'block';
            // R√©initialiser les champs
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
        }

        function showAppUI(user) {
            hideAllContent();
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('appContent').style.display = 'block';
            
            const userEmail = document.getElementById('userEmail');
            const userAnonymous = document.getElementById('userAnonymous');
            
            if (user.isAnonymous) {
                userEmail.textContent = '';
                userAnonymous.textContent = 'Compte anonyme';
            } else {
                userEmail.textContent = user.email;
                userAnonymous.textContent = '';
            }
            
            // Afficher le premier onglet
            document.querySelector('.tab-button').click();
            
            // Charger les donn√©es
            loadUserData();
        }

        // === GESTION DES DONN√âES CORRIG√âE ===
        function loadDataFromLocalStorage() {
            try {
                console.log('Chargement des donn√©es locales...');
                
                // R√©initialiser les tableaux
                bookmakers = [];
                operations = [];
                tipsters = [];
                
                const savedBookmakers = localStorage.getItem('bookmakers');
                const savedOperations = localStorage.getItem('operations');
                const savedTipsters = localStorage.getItem('tipsters');
                
                if (savedBookmakers) { 
                    bookmakers = JSON.parse(savedBookmakers);
                    console.log('Bookmakers charg√©s:', bookmakers.length);
                }
                
                if (savedOperations) {
                    operations = JSON.parse(savedOperations);
                    console.log('Op√©rations charg√©es:', operations.length);
                }
                
                if (savedTipsters) {
                    tipsters = JSON.parse(savedTipsters);
                    console.log('Tipsters charg√©s:', tipsters.length);
                }
                
                // Si pas de donn√©es, cr√©er des bookmakers par d√©faut
                if (bookmakers.length === 0) {
                    bookmakers = [
                        {id: Date.now(), nom: 'Loro', soldeInitial: 100},
                        {id: Date.now() + 1, nom: 'bet365', soldeInitial: 100},
                        {id: Date.now() + 2, nom: 'Betclic', soldeInitial: 100}
                    ];
                    console.log('Bookmakers par d√©faut cr√©√©s');
                    saveDataToLocalStorage();
                }
                
            } catch (error) {
                console.error('Erreur chargement local:', error);
                // R√©initialiser avec des donn√©es par d√©faut
                bookmakers = [
                    {id: Date.now(), nom: 'Loro', soldeInitial: 100},
                    {id: Date.now() + 1, nom: 'bet365', soldeInitial: 100},
                    {id: Date.now() + 2, nom: 'Betclic', soldeInitial: 100}
                ];
                operations = [];
                tipsters = [];
                saveDataToLocalStorage();
                console.log('Donn√©es r√©initialis√©es suite √† une erreur');
            }
        }

        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('bookmakers', JSON.stringify(bookmakers));
                localStorage.setItem('operations', JSON.stringify(operations));
                localStorage.setItem('tipsters', JSON.stringify(tipsters));
                console.log('Donn√©es sauvegard√©es localement');
            } catch (error) {
                console.error('Erreur sauvegarde locale:', error);
            }
        }

        function saveData() {
            saveDataToLocalStorage();
            if (currentUser && database) {
                saveDataToFirebase();
            }
        }

        // === FONCTIONS FIREBASE MANQUANTES ===
        async function saveDataToFirebase() {
            if (!currentUser || !database) return;
            
            try {
                isSyncing = true;
                showSyncStatus('üîÑ Sauvegarde...', 'syncing');
                
                const userData = {
                    bookmakers: bookmakers,
                    operations: operations,
                    tipsters: tipsters,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref('users/' + currentUser.uid).set(userData);
                showSyncStatus('‚úÖ Donn√©es sauvegard√©es', 'synced');
                
                setTimeout(() => {
                    document.getElementById('syncStatus').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                showSyncStatus('‚ùå Erreur sauvegarde', 'error');
            } finally {
                isSyncing = false;
            }
        }

        async function loadUserData() {
            if (!currentUser || !database) {
                loadDataFromLocalStorage();
                updateUI();
                return;
            }
            
            try {
                showSyncStatus('üîÑ Chargement...', 'syncing');
                
                // Afficher le loader sur mobile
                if (isMobile) {
                    document.getElementById('mobileLoader').classList.add('active');
                }
                
                const snapshot = await database.ref('users/' + currentUser.uid).once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    bookmakers = userData.bookmakers || [];
                    operations = userData.operations || [];
                    tipsters = userData.tipsters || [];
                    console.log('Donn√©es charg√©es depuis Firebase');
                } else {
                    // Premi√®re connexion - initialiser avec donn√©es locales ou par d√©faut
                    loadDataFromLocalStorage();
                    console.log('Nouvel utilisateur - donn√©es initialis√©es');
                }
                
                updateUI();
                showSyncStatus('‚úÖ Donn√©es charg√©es', 'synced');
                
                setTimeout(() => {
                    document.getElementById('syncStatus').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
                showSyncStatus('‚ùå Erreur chargement', 'error');
                // En cas d'erreur, charger les donn√©es locales
                loadDataFromLocalStorage();
                updateUI();
            } finally {
                if (isMobile) {
                    document.getElementById('mobileLoader').classList.remove('active');
                }
            }
        }

        // === FONCTIONS D'AUTHENTIFICATION ===
        async function login() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            try {
                showSyncStatus('üîÑ Connexion...', 'syncing');
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('Erreur connexion:', error);
                alert('Erreur de connexion: ' + error.message);
            }
        }

        async function signup() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (password.length < 6) {
                alert('Le mot de passe doit contenir au moins 6 caract√®res');
                return;
            }
            
            try {
                showSyncStatus('üîÑ Cr√©ation du compte...', 'syncing');
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('Erreur cr√©ation compte:', error);
                alert('Erreur de cr√©ation de compte: ' + error.message);
            }
        }

        async function loginAnonymously() {
            try {
                showSyncStatus('üîÑ Connexion...', 'syncing');
                await auth.signInAnonymously();
            } catch (error) {
                console.error('Erreur connexion anonyme:', error);
                alert('Erreur de connexion anonyme: ' + error.message);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
            } catch (error) {
                alert('Erreur de d√©connexion: ' + error.message);
            }
        }

        // === INITIALISATION ===
        window.addEventListener('DOMContentLoaded', function() {
            console.log('D√©marrage de l application...');
            setupEvents();
            initializeApp();
            setupTabsScroll();
        });

        // === FONCTIONS DE BASE EXISTANTES ===
        function setupEvents() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button, .tab-content').forEach(el => {
                        el.classList.remove('active');
                        if (el.classList.contains('tab-content')) {
                            el.style.display = 'none';
                        }
                    });
                    this.classList.add('active');
                    const tabContent = document.getElementById(this.dataset.tab);
                    tabContent.classList.add('active');
                    tabContent.style.display = 'block';
                    
                    if (this.dataset.tab === 'statistiques') renderStats();
                    if (this.dataset.tab === 'bookmakers') renderBookmakers();
                    if (this.dataset.tab === 'suivi-operations') renderOperations();
                    if (this.dataset.tab === 'tipsters') renderTipsters();
                });
            });

            document.getElementById('operationType').addEventListener('change', function() {
                if (this.value === 'Pari') {
                    document.getElementById('pariFields').style.display = 'block';
                    document.getElementById('depotRetraitFields').style.display = 'none';
                } else {
                    document.getElementById('pariFields').style.display = 'none';
                    document.getElementById('depotRetraitFields').style.display = 'block';
                }
            });

            document.getElementById('mise').addEventListener('input', calcGain);
            document.getElementById('cote').addEventListener('input', calcGain);

            // Recherche de matchs
            document.getElementById('matchSearch').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchMatches, 300);
            });
        }

        function updateUI() {
            console.log('Mise √† jour de l interface...');
            try {
                updateSelects();
                renderBookmakers();
                renderOperations();
                renderTipsters();
                renderStats();
                
                const now = new Date();
                document.getElementById('dateOperation').value = now.toISOString().split('T')[0];
                document.getElementById('heureOperation').value = now.toTimeString().slice(0, 5);
                
                console.log('Interface mise √† jour avec succ√®s');
            } catch (error) {
                console.error('Erreur mise √† jour UI:', error);
            }
        }

        function updateSelects() {
            const bookHtml = bookmakers.map(b => `<option value="${b.nom}">${b.nom}</option>`).join('');
            document.getElementById('operationBookmaker').innerHTML = '<option value="">S√©lectionner un bookmaker</option>' + bookHtml;
            
            const tipHtml = tipsters.map(t => `<option value="${t.id}">${t.nom}</option>`).join('');
            document.getElementById('operationTipster').innerHTML = '<option value="">Aucun / Personnel</option>' + tipHtml;
        }

        // === FONCTIONS D'AFFICHAGE DES DONN√âES ===
        function renderBookmakers() {
            const container = document.getElementById('bookmakerList');
            if (!container) return;
            
            if (bookmakers.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Aucun bookmaker. Ajoutez-en un pour commencer !</p>';
                return;
            }
            
            container.innerHTML = bookmakers.map(b => {
                const soldeActuel = calcBookmakerBalance(b.id);
                return `
                    <div class="bookmaker-item">
                        <div>
                            <div class="bookmaker-name">${b.nom}</div>
                            <div class="bookmaker-balance">Solde initial: ${b.soldeInitial.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div class="bookmaker-current">${soldeActuel.toFixed(2)}‚Ç¨</div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="editBookmaker(${b.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBookmaker(${b.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderOperations() {
            const tbody = document.getElementById('operationsTableBody');
            if (!tbody) return;
            
            if (operations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; color: #9ca3af; padding: 40px;">Aucune op√©ration</td></tr>';
                return;
            }

            const sortedOperations = [...operations].sort((a, b) => {
                const dateA = new Date(a.dateOperation + 'T' + (a.heureOperation || '00:00'));
                const dateB = new Date(b.dateOperation + 'T' + (b.heureOperation || '00:00'));
                return dateB - dateA;
            });

            tbody.innerHTML = sortedOperations.map(op => {
                let resultat = '-';
                if (op.type === 'Pari') {
                    if (op.statut === 'Gagn√©') resultat = '+' + (op.mise * op.cote - op.mise).toFixed(2) + '‚Ç¨';
                    else if (op.statut === 'Perdu') resultat = '-' + op.mise.toFixed(2) + '‚Ç¨';
                    else if (op.statut === 'Rembours√©') resultat = '0‚Ç¨';
                    else if (op.statut === 'Cash-out') resultat = '+' + (op.cashoutAmount - op.mise).toFixed(2) + '‚Ç¨';
                } else if (op.type === 'Frais') {
                    resultat = '-' + op.montant.toFixed(2) + '‚Ç¨';
                } else {
                    resultat = (op.type === 'D√©p√¥t' ? '+' : '-') + op.montant.toFixed(2) + '‚Ç¨';
                }
                
                let badge = 'badge-info';
                if (op.statut === 'Gagn√©') badge = 'badge-success';
                else if (op.statut === 'Perdu') badge = 'badge-danger';
                else if (op.statut === 'En cours') badge = 'badge-warning';
                else if (op.statut === 'Cash-out') badge = 'badge-info';
                else if (op.type !== 'Pari') badge = 'badge-secondary';
                
                let tipsterName = '-';
                if (op.tipster) {
                    const tip = tipsters.find(t => t.id == op.tipster);
                    if (tip) tipsterName = tip.nom;
                }

                const sportIcon = sportIcons[op.sport] || 'üèÜ';
                const dateHeure = op.dateOperation + (op.heureOperation ? '<br><small>' + op.heureOperation + '</small>' : '');
                
                let actionsHtml = `
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editOperation(${op.id})" title="Modifier">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOperation(${op.id})" title="Supprimer">üóëÔ∏è</button>
                `;
                
                if (op.type === 'Pari' && op.statut === 'En cours') {
                    actionsHtml += `
                        <button class="btn btn-success btn-sm" onclick="updateOperationStatus(${op.id}, 'Gagn√©')" title="Gagn√©">‚úì</button>
                        <button class="btn btn-danger btn-sm" onclick="updateOperationStatus(${op.id}, 'Perdu')" title="Perdu">‚úó</button>
                        <button class="btn btn-warning btn-sm" onclick="updateOperationStatus(${op.id}, 'Rembours√©')" title="Rembours√©">‚Ü∫</button>
                        <button class="btn btn-info btn-sm" onclick="showCashoutModal(${op.id})" title="Cash-out">üí∞</button>
                    `;
                }
                
                actionsHtml += '</div>';
                
                return `
                    <tr>
                        <td>${dateHeure}</td>
                        <td>${op.type}</td>
                        <td>${op.bookmaker}</td>
                        <td>${op.sport ? `<span class="sport-icon">${sportIcon}</span> ${op.sport}` : '-'}</td>
                        <td>${op.match || '-'}</td>
                        <td>${op.selection || '-'}</td>
                        <td>${op.typePari || '-'}</td>
                        <td>${tipsterName}</td>
                        <td>${op.mise ? op.mise.toFixed(2) + '‚Ç¨' : '-'}</td>
                        <td>${op.cote || '-'}</td>
                        <td><span class="badge ${badge}">${op.statut || '-'}</span></td>
                        <td>${resultat}</td>
                        <td>${actionsHtml}</td>
                    </tr>`;
            }).join('');
        }

        function renderTipsters() {
            const container = document.getElementById('tipsterList');
            if (!container) return;
            
            if (tipsters.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Aucun tipster. Ajoutez-en un pour commencer !</p>';
                return;
            }
            
            container.innerHTML = tipsters.map(tipster => {
                const tipsterOperations = operations.filter(op => op.tipster == tipster.id);
                const paris = tipsterOperations.filter(op => op.type === 'Pari');
                const gagnes = paris.filter(op => op.statut === 'Gagn√©').length;
                const perdus = paris.filter(op => op.statut === 'Perdu').length;
                const enCours = paris.filter(op => op.statut === 'En cours').length;
                const tauxReussite = paris.length > 0 ? ((gagnes / paris.length) * 100).toFixed(1) : 0;
                
                return `
                    <div class="tipster-card" onclick="showTipsterDetails(${tipster.id})">
                        <div class="tipster-header">
                            <div class="tipster-name">${tipster.nom}</div>
                            <span class="badge ${tauxReussite >= 50 ? 'badge-success' : 'badge-danger'}">${tauxReussite}%</span>
                        </div>
                        ${tipster.description ? `<p style="color: #6b7280; margin-bottom: 10px;">${tipster.description}</p>` : ''}
                        <div class="tipster-stats">
                            <div class="tipster-stat">
                                <div class="tipster-stat-value">${paris.length}</div>
                                <div class="tipster-stat-label">Paris</div>
                            </div>
                            <div class="tipster-stat">
                                <div class="tipster-stat-value">${gagnes}</div>
                                <div class="tipster-stat-label">Gagn√©s</div>
                            </div>
                            <div class="tipster-stat">
                                <div class="tipster-stat-value">${enCours}</div>
                                <div class="tipster-stat-label">En cours</div>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderStats() {
            const container = document.getElementById('statsGrid');
            if (!container) return;
            
            // Calcul des statistiques
            const paris = operations.filter(op => op.type === 'Pari');
            const parisTermines = paris.filter(op => op.statut === 'Gagn√©' || op.statut === 'Perdu' || op.statut === 'Cash-out');
            const parisGagnes = paris.filter(op => op.statut === 'Gagn√©' || op.statut === 'Cash-out');
            const tauxReussite = parisTermines.length > 0 ? ((parisGagnes.length / parisTermines.length) * 100).toFixed(1) : 0;
            
            let profitTotal = 0;
            paris.forEach(pari => {
                if (pari.statut === 'Gagn√©') profitTotal += (pari.mise * pari.cote - pari.mise);
                else if (pari.statut === 'Perdu') profitTotal -= pari.mise;
                else if (pari.statut === 'Cash-out') profitTotal += (pari.cashoutAmount - pari.mise);
            });
            
            const depots = operations.filter(op => op.type === 'D√©p√¥t').reduce((sum, op) => sum + op.montant, 0);
            const retraits = operations.filter(op => op.type === 'Retrait').reduce((sum, op) => sum + op.montant, 0);
            const bankrollTotale = depots - retraits + profitTotal;
            
            const roi = depots > 0 ? ((profitTotal / depots) * 100).toFixed(1) : 0;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Bankroll Totale</div>
                    <div class="stat-value">${bankrollTotale.toFixed(2)}‚Ç¨</div>
                </div>
                <div class="stat-card ${profitTotal >= 0 ? 'green' : 'red'}">
                    <div class="stat-label">Profit Total</div>
                    <div class="stat-value">${profitTotal >= 0 ? '+' : ''}${profitTotal.toFixed(2)}‚Ç¨</div>
                </div>
                <div class="stat-card ${tauxReussite >= 50 ? 'green' : 'red'}">
                    <div class="stat-label">Taux de R√©ussite</div>
                    <div class="stat-value">${tauxReussite}%</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">ROI</div>
                    <div class="stat-value">${roi}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Paris Play√©s</div>
                    <div class="stat-value">${paris.length}</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Paris Gagn√©s</div>
                    <div class="stat-value">${parisGagnes.length}</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Paris Perdus</div>
                    <div class="stat-value">${paris.filter(op => op.statut === 'Perdu').length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Paris En Cours</div>
                    <div class="stat-value">${paris.filter(op => op.statut === 'En cours').length}</div>
                </div>`;
        }

        // === FONCTIONS UTILITAIRES ===
        function showSyncStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.className = `sync-status ${type}`;
            statusEl.style.display = 'block';
        }

        function setupTabsScroll() {
            const tabs = document.getElementById('mainTabs');
            const indicator = document.getElementById('scrollIndicator');
            
            if (tabs && indicator) {
                tabs.addEventListener('scroll', function() {
                    const isAtEnd = tabs.scrollLeft + tabs.clientWidth >= tabs.scrollWidth - 10;
                    indicator.style.display = isAtEnd ? 'none' : 'flex';
                });
            }
        }

        function calcGain() {
            const mise = parseFloat(document.getElementById('mise').value) || 0;
            const cote = parseFloat(document.getElementById('cote').value) || 0;
            const gain = (mise * cote - mise).toFixed(2);
            document.getElementById('gainPotentiel').textContent = gain + ' ‚Ç¨';
        }

        function saveOperation() {
            const type = document.getElementById('operationType').value;
            const bookmaker = document.getElementById('operationBookmaker').value;
            const date = document.getElementById('dateOperation').value;
            const heure = document.getElementById('heureOperation').value;
            
            if (!bookmaker) {
                alert('Veuillez s√©lectionner un bookmaker');
                return;
            }
            
            let operation = {
                id: editingOperationId || Date.now(),
                type: type,
                bookmaker: bookmaker,
                dateOperation: date,
                heureOperation: heure
            };
            
            if (type === 'Pari') {
                operation.sport = document.getElementById('sport').value;
                operation.match = document.getElementById('match').value;
                operation.selection = document.getElementById('selection').value;
                operation.typePari = document.getElementById('typePari').value;
                operation.mise = parseFloat(document.getElementById('mise').value) || 0;
                operation.cote = parseFloat(document.getElementById('cote').value) || 0;
                operation.statut = document.getElementById('statut').value;
                operation.tipster = document.getElementById('operationTipster').value;
                
                if (!operation.sport || !operation.match || !operation.selection) {
                    alert('Veuillez remplir tous les champs du pari');
                    return;
                }
            } else {
                operation.montant = parseFloat(document.getElementById('montant').value) || 0;
                
                if (operation.montant <= 0) {
                    alert('Veuillez saisir un montant valide');
                    return;
                }
            }
            
            if (editingOperationId) {
                // Modification
                const index = operations.findIndex(op => op.id === editingOperationId);
                if (index !== -1) {
                    operations[index] = operation;
                }
                editingOperationId = null;
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.getElementById('editModeBanner').style.display = 'none';
            } else {
                // Nouvelle op√©ration
                operations.push(operation);
            }
            
            saveData();
            updateUI();
            resetOperationForm();
            
            alert(editingOperationId ? 'Op√©ration modifi√©e !' : 'Op√©ration enregistr√©e !');
        }

        function resetOperationForm() {
            document.getElementById('operationType').value = 'Pari';
            document.getElementById('operationBookmaker').selectedIndex = 0;
            document.getElementById('dateOperation').value = new Date().toISOString().split('T')[0];
            document.getElementById('heureOperation').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('sport').value = '';
            document.getElementById('match').value = '';
            document.getElementById('selection').value = '';
            document.getElementById('typePari').value = 'Simple';
            document.getElementById('mise').value = '';
            document.getElementById('cote').value = '';
            document.getElementById('statut').value = 'En cours';
            document.getElementById('operationTipster').selectedIndex = 0;
            document.getElementById('montant').value = '';
            document.getElementById('pariFields').style.display = 'block';
            document.getElementById('depotRetraitFields').style.display = 'none';
            document.getElementById('gainPotentiel').textContent = '0.00 ‚Ç¨';
        }

        function calcBookmakerBalance(bookmakerId) {
            const bookmaker = bookmakers.find(b => b.id === bookmakerId);
            if (!bookmaker) return 0;
            
            let balance = bookmaker.soldeInitial || 0;
            
            operations.forEach(op => {
                if (op.bookmaker === bookmaker.nom) {
                    if (op.type === 'Pari') {
                        if (op.statut === 'Gagn√©') balance += (op.mise * op.cote - op.mise);
                        else if (op.statut === 'Perdu') balance -= op.mise;
                        else if (op.statut === 'Cash-out') balance += (op.cashoutAmount - op.mise);
                        // "En cours" et "Rembours√©" n'affectent pas le solde
                    } else if (op.type === 'D√©p√¥t') {
                        balance += op.montant;
                    } else if (op.type === 'Retrait' || op.type === 'Frais') {
                        balance -= op.montant;
                    }
                }
            });
            
            return balance;
        }

        // === FONCTIONS POUR LES OPERATIONS ===
        function editOperation(id) {
            const operation = operations.find(op => op.id === id);
            if (!operation) return;
            
            editingOperationId = id;
            
            // Remplir le formulaire avec les donn√©es de l'op√©ration
            document.getElementById('operationType').value = operation.type;
            document.getElementById('operationBookmaker').value = operation.bookmaker;
            document.getElementById('dateOperation').value = operation.dateOperation;
            document.getElementById('heureOperation').value = operation.heureOperation || '';
            
            if (operation.type === 'Pari') {
                document.getElementById('sport').value = operation.sport || '';
                document.getElementById('match').value = operation.match || '';
                document.getElementById('selection').value = operation.selection || '';
                document.getElementById('typePari').value = operation.typePari || 'Simple';
                document.getElementById('mise').value = operation.mise || '';
                document.getElementById('cote').value = operation.cote || '';
                document.getElementById('statut').value = operation.statut || 'En cours';
                document.getElementById('operationTipster').value = operation.tipster || '';
                
                document.getElementById('pariFields').style.display = 'block';
                document.getElementById('depotRetraitFields').style.display = 'none';
                calcGain();
            } else {
                document.getElementById('montant').value = operation.montant || '';
                document.getElementById('pariFields').style.display = 'none';
                document.getElementById('depotRetraitFields').style.display = 'block';
            }
            
            document.getElementById('editModeBanner').style.display = 'block';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Basculer vers l'onglet d'enregistrement
            document.querySelector('[data-tab="enregistrer"]').click();
        }

        function cancelEdit() {
            editingOperationId = null;
            document.getElementById('editModeBanner').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            resetOperationForm();
        }

        function deleteOperation(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette op√©ration ?')) {
                operations = operations.filter(op => op.id !== id);
                saveData();
                renderOperations();
            }
        }

        function updateOperationStatus(id, status) {
            const operation = operations.find(op => op.id === id);
            if (operation) {
                operation.statut = status;
                saveData();
                renderOperations();
                alert(`Statut mis √† jour : ${status}`);
            }
        }

        function showCashoutModal(id) {
            currentCashoutId = id;
            document.getElementById('cashoutModal').classList.add('active');
            document.getElementById('cashoutAmount').value = '';
        }

        function closeCashoutModal() {
            document.getElementById('cashoutModal').classList.remove('active');
            currentCashoutId = null;
        }

        function confirmCashout() {
            const amount = parseFloat(document.getElementById('cashoutAmount').value);
            if (!amount || amount <= 0) {
                alert('Veuillez saisir un montant valide');
                return;
            }
            
            const operation = operations.find(op => op.id === currentCashoutId);
            if (operation) {
                operation.statut = 'Cash-out';
                operation.cashoutAmount = amount;
                saveData();
                renderOperations();
                closeCashoutModal();
                alert('Cash-out enregistr√© !');
            }
        }

        // === FONCTIONS POUR LES BOOKMAKERS ===
        function showBookmakerForm() {
            document.getElementById('bookmakerFormContainer').style.display = 'block';
            document.getElementById('bookmakerFormTitle').textContent = 'Nouveau Bookmaker';
            editingBookmakerId = null;
            document.getElementById('bookmakerNom').value = '';
            document.getElementById('bookmakerSolde').value = '';
        }

        function saveBookmaker() {
            const nom = document.getElementById('bookmakerNom').value;
            const solde = parseFloat(document.getElementById('bookmakerSolde').value) || 0;
            
            if (!nom) {
                alert('Veuillez saisir un nom');
                return;
            }
            
            const bookmaker = {
                id: editingBookmakerId || Date.now(),
                nom: nom,
                soldeInitial: solde
            };
            
            if (editingBookmakerId) {
                const index = bookmakers.findIndex(b => b.id === editingBookmakerId);
                if (index !== -1) bookmakers[index] = bookmaker;
            } else {
                bookmakers.push(bookmaker);
            }
            
            saveData();
            renderBookmakers();
            updateSelects();
            cancelBookmakerForm();
        }

        function cancelBookmakerForm() {
            document.getElementById('bookmakerFormContainer').style.display = 'none';
            document.getElementById('bookmakerNom').value = '';
            document.getElementById('bookmakerSolde').value = '';
        }

        function editBookmaker(id) {
            const bookmaker = bookmakers.find(b => b.id === id);
            if (bookmaker) {
                editingBookmakerId = id;
                document.getElementById('bookmakerFormContainer').style.display = 'block';
                document.getElementById('bookmakerFormTitle').textContent = 'Modifier Bookmaker';
                document.getElementById('bookmakerNom').value = bookmaker.nom;
                document.getElementById('bookmakerSolde').value = bookmaker.soldeInitial;
            }
        }

        function deleteBookmaker(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce bookmaker ?')) {
                bookmakers = bookmakers.filter(b => b.id !== id);
                // Supprimer aussi les op√©rations associ√©es
                operations = operations.filter(op => {
                    const bookmaker = bookmakers.find(b => b.nom === op.bookmaker);
                    return bookmaker !== undefined;
                });
                saveData();
                renderBookmakers();
                updateSelects();
            }
        }

        // === FONCTIONS POUR LES TIPSTERS ===
        function showTipsterForm() {
            document.getElementById('tipsterFormContainer').style.display = 'block';
            document.getElementById('tipsterFormTitle').textContent = 'Nouveau Tipster';
            editingTipsterId = null;
            document.getElementById('tipsterNom').value = '';
            document.getElementById('tipsterDescription').value = '';
        }

        function saveTipster() {
            const nom = document.getElementById('tipsterNom').value;
            const description = document.getElementById('tipsterDescription').value;
            
            if (!nom) {
                alert('Veuillez saisir un nom');
                return;
            }
            
            const tipster = {
                id: editingTipsterId || Date.now(),
                nom: nom,
                description: description
            };
            
            if (editingTipsterId) {
                const index = tipsters.findIndex(t => t.id === editingTipsterId);
                if (index !== -1) tipsters[index] = tipster;
            } else {
                tipsters.push(tipster);
            }
            
            saveData();
            renderTipsters();
            updateSelects();
            cancelTipsterForm();
        }

        function cancelTipsterForm() {
            document.getElementById('tipsterFormContainer').style.display = 'none';
            document.getElementById('tipsterNom').value = '';
            document.getElementById('tipsterDescription').value = '';
        }

        function showTipsterDetails(id) {
            const tipster = tipsters.find(t => t.id === id);
            if (!tipster) return;
            
            const tipsterOperations = operations.filter(op => op.tipster == tipster.id);
            const paris = tipsterOperations.filter(op => op.type === 'Pari');
            const parisTermines = paris.filter(op => op.statut === 'Gagn√©' || op.statut === 'Perdu' || op.statut === 'Cash-out');
            const parisGagnes = paris.filter(op => op.statut === 'Gagn√©' || op.statut === 'Cash-out');
            const tauxReussite = parisTermines.length > 0 ? ((parisGagnes.length / parisTermines.length) * 100).toFixed(1) : 0;
            
            let profitTotal = 0;
            paris.forEach(pari => {
                if (pari.statut === 'Gagn√©') profitTotal += (pari.mise * pari.cote - pari.mise);
                else if (pari.statut === 'Perdu') profitTotal -= pari.mise;
                else if (pari.statut === 'Cash-out') profitTotal += (pari.cashoutAmount - pari.mise);
            });
            
            const miseTotale = paris.reduce((sum, pari) => sum + (pari.mise || 0), 0);
            const roi = miseTotale > 0 ? ((profitTotal / miseTotale) * 100).toFixed(1) : 0;
            
            document.getElementById('tipsterDetailsTitle').textContent = `D√©tails: ${tipster.nom}`;
            document.getElementById('tipsterDetailsStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Paris Totaux</div>
                    <div class="stat-value">${paris.length}</div>
                </div>
                <div class="stat-card ${tauxReussite >= 50 ? 'green' : 'red'}">
                    <div class="stat-label">Taux de R√©ussite</div>
                    <div class="stat-value">${tauxReussite}%</div>
                </div>
                <div class="stat-card ${profitTotal >= 0 ? 'green' : 'red'}">
                    <div class="stat-label">Profit Total</div>
                    <div class="stat-value">${profitTotal >= 0 ? '+' : ''}${profitTotal.toFixed(2)}‚Ç¨</div>
                </div>
                <div class="stat-card ${roi >= 0 ? 'green' : 'red'}">
                    <div class="stat-label">ROI</div>
                    <div class="stat-value">${roi}%</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Paris Gagn√©s</div>
                    <div class="stat-value">${parisGagnes.length}</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Paris Perdus</div>
                    <div class="stat-value">${paris.filter(op => op.statut === 'Perdu').length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mise Totale</div>
                    <div class="stat-value">${miseTotale.toFixed(2)}‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Paris En Cours</div>
                    <div class="stat-value">${paris.filter(op => op.statut === 'En cours').length}</div>
                </div>`;
            
            document.getElementById('tipsterList').style.display = 'none';
            document.getElementById('tipsterFormContainer').style.display = 'none';
            document.getElementById('tipsterDetailsContainer').style.display = 'block';
        }

        function closeTipsterDetails() {
            document.getElementById('tipsterDetailsContainer').style.display = 'none';
            document.getElementById('tipsterList').style.display = 'block';
        }

        // === FONCTIONS DE RECHERCHE DE MATCHS ===
        function searchMatches() {
            const query = document.getElementById('matchSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('autocompleteResults');
            
            if (query.length < 2) {
                resultsContainer.classList.remove('active');
                return;
            }
            
            const filteredMatches = mockMatches.filter(match => 
                match.home.toLowerCase().includes(query) || 
                match.away.toLowerCase().includes(query)
            );
            
            if (filteredMatches.length === 0) {
                resultsContainer.innerHTML = '<div class="autocomplete-item">Aucun match trouv√©</div>';
            } else {
                resultsContainer.innerHTML = filteredMatches.map(match => `
                    <div class="autocomplete-item" onclick="selectMatch('${match.sport}', '${match.home} vs ${match.away}', '${match.home}')">
                        <div class="match-info">${match.home} vs ${match.away}</div>
                        <div class="match-meta">${match.sport} ‚Ä¢ ${match.date} ${match.time}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.classList.add('active');
        }

        function selectMatch(sport, match, selection) {
            document.getElementById('sport').value = sport;
            document.getElementById('match').value = match;
            document.getElementById('selection').value = selection;
            document.getElementById('autocompleteResults').classList.remove('active');
            document.getElementById('matchSearch').value = '';
        }

        // === FONCTIONS D'EXPORT/IMPORT ===
        function exportData() {
            const data = {
                bookmakers: bookmakers,
                operations: operations,
                tipsters: tipsters,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bankroll-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Voulez-vous remplacer toutes vos donn√©es actuelles ?')) {
                        bookmakers = data.bookmakers || [];
                        operations = data.operations || [];
                        tipsters = data.tipsters || [];
                        saveData();
                        updateUI();
                        alert('Donn√©es import√©es avec succ√®s !');
                    }
                } catch (error) {
                    alert('Erreur lors de l\'import : fichier invalide');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetApp() {
            if (confirm('√ätes-vous ABSOLUMENT s√ªr de vouloir r√©initialiser toutes vos donn√©es ? Cette action est irr√©versible.')) {
                bookmakers = [];
                operations = [];
                tipsters = [];
                saveData();
                updateUI();
                alert('Application r√©initialis√©e');
            }
        }
    </script>
</body>
</html>
