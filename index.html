<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Suivi de bankroll ‚Äî Fix</title>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
/* simplified styles (kept look similar) */
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#111}
.container{max-width:1100px;margin:0 auto}
.header{text-align:center;color:#fff;margin-bottom:20px}
.tabs{display:flex;gap:6px;background:#fff;padding:8px;border-radius:8px}
.tab-button{background:#fff;border:none;padding:12px 14px;cursor:pointer;border-bottom:3px solid transparent;font-weight:600;color:#6b7280}
.tab-button.active{background:#eff6ff;color:#3b82f6;border-bottom-color:#3b82f6}
.tab-content{display:none;background:#fff;padding:18px;border-radius:0 0 8px 8px;margin-top:0}
.tab-content.active{display:block}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:12px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:700px){.form-grid{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.sync-status{position:fixed;right:16px;top:16px;background:#fff;padding:8px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.08)}
.firebase-error{background:#fee2e2;color:#991b1b;padding:10px;border-radius:6px;display:none}
.gain-display{background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);color:#fff;padding:10px;border-radius:6px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="sync-status" id="syncStatus" style="display:none">üîÑ</div>
  <div class="header">
    <h1>üí∞ Suivi de bankroll</h1>
    <p>G√©rez vos paris sportifs</p>
  </div>

  <div id="firebaseError" class="firebase-error">‚ùå Firebase indisponible, mode local</div>

  <div id="authContainer" class="card">
    <h3>üîê Connexion</h3>
    <div style="max-width:420px;margin:0 auto">
      <div class="form-grid" style="margin-bottom:8px">
        <div><label>Email</label><input id="authEmail" type="email" style="width:100%;padding:8px"/></div>
        <div><label>Mot de passe</label><input id="authPassword" type="password" style="width:100%;padding:8px"/></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="tab-button" onclick="login()">Se connecter</button>
        <button class="tab-button" onclick="signup()">Cr√©er</button>
        <button class="tab-button" onclick="loginAnonymously()">Anonyme</button>
      </div>
    </div>
  </div>

  <div id="userInfo" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong id="userEmailDisplay"></strong> <span id="userAnon" style="color:#6b7280"></span></div>
      <div><button onclick="logout()">D√©connexion</button></div>
    </div>
  </div>

  <div class="tabs" id="mainTabs" style="display:none">
    <button class="tab-button active" data-tab="enregistrer">Enregistrer</button>
    <button class="tab-button" data-tab="suivi-operations">Suivi</button>
    <button class="tab-button" data-tab="tipsters">Tipsters</button>
    <button class="tab-button" data-tab="bookmakers">Bookmakers</button>
    <button class="tab-button" data-tab="statistiques">Stats</button>
    <button class="tab-button" data-tab="reglages">R√©glages</button>
  </div>

  <div id="enregistrer" class="tab-content active">
    <div class="card">
      <h3>Enregistrer une op√©ration</h3>
      <div class="form-grid" style="margin-bottom:10px">
        <div>
          <label>Type</label>
          <select id="operationType" style="width:100%;padding:8px">
            <option>Pari</option><option>D√©p√¥t</option><option>Retrait</option><option>Frais</option>
          </select>
        </div>
        <div>
          <label>Bookmaker</label>
          <select id="operationBookmaker" style="width:100%;padding:8px"><option value="">S√©lectionner</option></select>
        </div>
      </div>

      <div class="form-grid" style="margin-bottom:10px">
        <div><label>Date</label><input id="dateOperation" type="date" style="width:100%;padding:8px"/></div>
        <div><label>Heure</label><input id="heureOperation" type="time" style="width:100%;padding:8px"/></div>
      </div>

      <div id="pariFields">
        <div class="form-grid" style="margin-bottom:10px">
          <div><label>Sport</label><input id="sport" style="width:100%;padding:8px"/></div>
          <div><label>Match</label><input id="match" style="width:100%;padding:8px"/></div>
        </div>
        <div class="form-grid" style="margin-bottom:10px">
          <div><label>Mise (‚Ç¨)</label><input id="mise" type="number" step="0.01" style="width:100%;padding:8px"/></div>
          <div><label>C√¥te</label><input id="cote" type="number" step="0.01" style="width:100%;padding:8px"/></div>
        </div>
        <div style="margin-bottom:10px"><label>Gain net</label><div id="gainPotentiel" class="gain-display">0.00 ‚Ç¨</div></div>
      </div>

      <div id="depotRetraitFields" style="display:none">
        <div style="margin-bottom:10px"><label>Montant (‚Ç¨)</label><input id="montant" type="number" step="0.01" style="width:100%;padding:8px"/></div>
      </div>

      <div style="display:flex;gap:8px">
        <button onclick="saveOperation()" class="tab-button">Enregistrer</button>
        <button onclick="resetOperationForm()" class="tab-button">R√©initialiser</button>
      </div>
    </div>
  </div>

  <div id="suivi-operations" class="tab-content">
    <div class="card">
      <h3>Suivi des op√©rations</h3>
      <div style="overflow:auto">
        <table class="table" id="operationsTable">
          <thead><tr><th>Date</th><th>Type</th><th>Bookmaker</th><th>Mise</th><th>C√¥te</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="operationsTableBody"><tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:20px">Aucune op√©ration</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tipsters" class="tab-content">
    <div class="card">
      <h3>Tipsters</h3>
      <div id="tipsterList"></div>
    </div>
  </div>

  <div id="bookmakers" class="tab-content">
    <div class="card">
      <h3>Bookmakers</h3>
      <div id="bookmakerList"></div>
      <div style="margin-top:8px">
        <input id="bookmakerNom" placeholder="Nom" style="padding:8px;width:240px"/>
        <input id="bookmakerSolde" placeholder="Solde initial" type="number" step="0.01" style="padding:8px;width:140px"/>
        <button onclick="saveBookmaker()">Ajouter</button>
      </div>
    </div>
  </div>

  <div id="statistiques" class="tab-content">
    <div class="card">
      <h3>Statistiques</h3>
      <div id="statsGrid"></div>
    </div>
  </div>

  <div id="reglages" class="tab-content">
    <div class="card">
      <h3>R√©glages & Import/Export</h3>
      <div style="display:flex;gap:8px">
        <button onclick="exportData()">Exporter JSON</button>
        <input type="file" id="importFile" accept=".json" onchange="importData(event)"/>
        <button onclick="resetApp()">R√©initialiser</button>
      </div>
    </div>
  </div>

</div>

<script>
// ----- CONFIG FIREBASE -----
const firebaseConfig = {
  apiKey: "AIzaSyDbtGDuOVE4lYkVtLjZ0AnrpbWVnwcdvZI",
  authDomain: "bankroll-suivi.firebaseapp.com",
  databaseURL: "https://bankroll-suivi-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bankroll-suivi",
  storageBucket: "bankroll-suivi.appspot.com",
  messagingSenderId: "632546496211",
  appId: "1:632546496211:web:25375f3e496c4a43490e26"
};

// ----- STATE -----
let bookmakers = [];
let operations = [];
let tipsters = [];
let currentUser = null;
let auth = null;
let database = null;
let firebaseInitialized = false;
let searchTimeout = null;

// ----- UTIL -----
function showSyncStatus(msg, type){
  const el = document.getElementById('syncStatus');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=>el.style.display='none', 3500);
}

// ----- LOCAL STORAGE -----
function loadDataFromLocalStorage(){
  try{
    const b = localStorage.getItem('bookmakers');
    const o = localStorage.getItem('operations');
    const t = localStorage.getItem('tipsters');
    bookmakers = b? JSON.parse(b) : [{id:1,nom:'Loro',soldeInitial:100},{id:2,nom:'bet365',soldeInitial:100},{id:3,nom:'Betclic',soldeInitial:100}];
    operations = o? JSON.parse(o) : [];
    tipsters = t? JSON.parse(t) : [];
  }catch(e){
    console.error('load local err',e);
    bookmakers = [{id:1,nom:'Loro',soldeInitial:100},{id:2,nom:'bet365',soldeInitial:100},{id:3,nom:'Betclic',soldeInitial:100}];
    operations = []; tipsters = [];
  }
}

function saveDataToLocalStorage(){
  localStorage.setItem('bookmakers', JSON.stringify(bookmakers));
  localStorage.setItem('operations', JSON.stringify(operations));
  localStorage.setItem('tipsters', JSON.stringify(tipsters));
}

// ----- FIREBASE -----
async function initializeApp(){
  // hide UI until ready
  document.getElementById('mainTabs').style.display = 'none';
  document.getElementById('authContainer').style.display = 'none';
  document.getElementById('userInfo').style.display = 'none';

  try{
    if(typeof firebase === 'undefined') throw new Error('Firebase SDK not loaded');
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    database = firebase.database();
    firebaseInitialized = true;
    console.log('Firebase initialized');
    auth.onAuthStateChanged(async (user)=>{
      currentUser = user;
      if(user){
        showAppUI(user);
        await loadUserData();
      } else {
        // show auth screen
        showAuthUI();
      }
    }, (err)=>{
      console.error('auth err',err);
      showFirebaseError();
      showLocalMode();
    });
  }catch(err){
    console.warn('firebase init failed',err);
    showFirebaseError();
    showLocalMode();
  }
}

function showFirebaseError(){
  const el = document.getElementById('firebaseError');
  if(el) el.style.display = 'block';
}

function showAuthUI(){
  document.getElementById('authContainer').style.display = 'block';
  document.getElementById('mainTabs').style.display = 'none';
  document.getElementById('userInfo').style.display = 'none';
}

function showLocalMode(){
  loadDataFromLocalStorage();
  updateUI();
  document.getElementById('authContainer').style.display = 'none';
  document.getElementById('userInfo').style.display = 'none';
  document.getElementById('mainTabs').style.display = 'flex';
  // show default tab
  activateTabByName('enregistrer');
  showSyncStatus('üì± Mode local - Donn√©es locales');
}

function showAppUI(user){
  document.getElementById('authContainer').style.display = 'none';
  document.getElementById('userInfo').style.display = 'block';
  document.getElementById('mainTabs').style.display = 'flex';
  document.getElementById('userEmailDisplay').textContent = user.email || '';
  document.getElementById('userAnon').textContent = user.isAnonymous ? '(Compte anonyme)' : '';
  activateTabByName('enregistrer');
}

// firebase save/load
async function saveDataToFirebase(){
  if(!firebaseInitialized || !currentUser || !database) return;
  try{
    showSyncStatus('üîÑ Sauvegarde Firebase...');
    const payload = {bookmakers,operations,tipsters,lastUpdated:firebase.database.ServerValue.TIMESTAMP};
    await database.ref('users/' + currentUser.uid).set(payload);
    showSyncStatus('‚úÖ Donn√©es sauvegard√©es');
  }catch(e){console.error('save firebase',e);showSyncStatus('‚ùå Erreur sauvegarde');}
}

async function loadUserData(){
  if(!firebaseInitialized || !currentUser || !database){ loadDataFromLocalStorage(); updateUI(); return;}
  try{
    showSyncStatus('üîÑ Chargement Firebase...');
    const snap = await database.ref('users/' + currentUser.uid).once('value');
    const data = snap.val();
    if(data){
      bookmakers = data.bookmakers || [];
      operations = data.operations || [];
      tipsters = data.tipsters || [];
      showSyncStatus('‚úÖ Donn√©es charg√©es depuis Firebase');
    } else {
      loadDataFromLocalStorage();
    }
    updateUI();
  }catch(e){
    console.error('load user data',e);
    loadDataFromLocalStorage();
    updateUI();
    showSyncStatus('‚ö†Ô∏è Utilisation des donn√©es locales');
  }
}

// ----- AUTH -----
async function login(){
  if(!firebaseInitialized || !auth){ alert('Firebase indisponible ‚Äî mode local'); showLocalMode(); return; }
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  if(!email||!password){ alert('Remplir email et mot de passe'); return; }
  try{ showSyncStatus('üîÑ Connexion...'); await auth.signInWithEmailAndPassword(email,password); }
  catch(e){ alert('Erreur connexion: '+e.message); console.error(e); showLocalMode(); }
}
async function signup(){
  if(!firebaseInitialized || !auth){ alert('Firebase indisponible ‚Äî mode local'); showLocalMode(); return; }
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  if(!email||!password){ alert('Remplir email et mot de passe'); return; }
  if(password.length<6){ alert('Mot de passe >=6 caract√®res'); return; }
  try{ showSyncStatus('üîÑ Cr√©ation compte...'); await auth.createUserWithEmailAndPassword(email,password); }
  catch(e){ alert('Erreur cr√©ation compte: '+e.message); console.error(e); }
}
async function loginAnonymously(){
  if(!firebaseInitialized || !auth){ alert('Firebase indisponible ‚Äî mode local'); showLocalMode(); return; }
  try{ showSyncStatus('üîÑ Connexion anonyme...'); await auth.signInAnonymously(); }
  catch(e){ alert('Erreur connexion anonyme: '+e.message); console.error(e); }
}
async function logout(){ if(!firebaseInitialized || !auth){ showAuthUI(); return; } try{ await auth.signOut(); showAuthUI(); }catch(e){ alert('Erreur logout'); } }

// ----- UI / TABS -----
function setupEvents(){
  document.querySelectorAll('.tab-button').forEach(btn=>{
    btn.addEventListener('click', function(){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      this.classList.add('active');
      const tab = this.dataset.tab;
      document.getElementById(tab).classList.add('active');
      // call renderers for heavier tabs
      if(tab==='statistiques') renderStats();
      if(tab==='bookmakers') renderBookmakers();
      if(tab==='suivi-operations') renderOperations();
      if(tab==='tipsters') renderTipsters();
    });
  });

  document.getElementById('operationType').addEventListener('change', function(){
    if(this.value==='Pari'){ document.getElementById('pariFields').style.display='block'; document.getElementById('depotRetraitFields').style.display='none'; }
    else{ document.getElementById('pariFields').style.display='none'; document.getElementById('depotRetraitFields').style.display='block'; }
  });

  document.getElementById('mise').addEventListener('input', calcGain);
  document.getElementById('cote').addEventListener('input', calcGain);
}

function activateTabByName(name){
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.dataset.tab===name);
  if(btn) btn.classList.add('active');
  const cont = document.getElementById(name);
  if(cont) cont.classList.add('active');
}

// ----- CORE: render/update -----
function updateSelects(){
  const bookHtml = bookmakers.map(b=>`<option value="${b.nom}">${b.nom}</option>`).join('');
  document.getElementById('operationBookmaker').innerHTML = '<option value="">S√©lectionner</option>'+bookHtml;
}

function renderBookmakers(){
  const el = document.getElementById('bookmakerList');
  if(!el) return;
  el.innerHTML = bookmakers.map(b=>`<div style="padding:8px;border:1px solid #eee;margin-bottom:6px;border-radius:6px"><strong>${b.nom}</strong> ‚Äî Solde initial: ${b.soldeInitial.toFixed(2)}‚Ç¨</div>`).join('') || '<div>Aucun bookmaker</div>';
}

function renderOperations(){
  const tbody = document.getElementById('operationsTableBody');
  if(operations.length===0){ tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:20px">Aucune op√©ration</td></tr>'; return; }
  tbody.innerHTML = operations.map(op=>{
    return `<tr>
      <td>${op.dateOperation||''} ${op.heureOperation||''}</td>
      <td>${op.type}</td>
      <td>${op.bookmaker||''}</td>
      <td>${op.mise?op.mise.toFixed(2):''}</td>
      <td>${op.cote?op.cote:''}</td>
      <td>${op.statut||''}</td>
      <td>
        <button onclick="editOperation(${op.id})">‚úèÔ∏è</button>
        <button onclick="deleteOperation(${op.id})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

function renderTipsters(){ const el=document.getElementById('tipsterList'); el.innerHTML = tipsters.map(t=>`<div style="padding:8px;border:1px solid #eee;margin-bottom:6px;border-radius:6px">${t.nom||'(sans nom)'}</div>`).join('') || '<div>Aucun tipster</div>'; }

function renderStats(){
  const profit = operations.reduce((sum,o)=>{ if(o.type==='Pari' && (o.statut==='Gagn√©')) return sum + ((o.mise*(o.cote||1)) - o.mise); return sum; },0);
  document.getElementById('statsGrid').innerHTML = `<div>Profit estim√©: ${profit.toFixed(2)}‚Ç¨</div><div>Total op√©rations: ${operations.length}</div>`;
}

function updateUI(){
  updateSelects();
  renderBookmakers();
  renderOperations();
  renderTipsters();
  renderStats();
  const now = new Date();
  document.getElementById('dateOperation').value = now.toISOString().split('T')[0];
  document.getElementById('heureOperation').value = now.toTimeString().slice(0,5);
}

// ----- OPERATION CRUD -----
function calcGain(){
  const mise = parseFloat(document.getElementById('mise').value) || 0;
  const cote = parseFloat(document.getElementById('cote').value) || 0;
  const gain = mise * (cote - 1);
  document.getElementById('gainPotentiel').textContent = gain.toFixed(2) + ' ‚Ç¨';
}

function saveOperation(){
  const type = document.getElementById('operationType').value;
  const bookmaker = document.getElementById('operationBookmaker').value;
  const dateOperation = document.getElementById('dateOperation').value;
  const heureOperation = document.getElementById('heureOperation').value;
  if(type==='Pari'){
    const mise = parseFloat(document.getElementById('mise').value) || 0;
    const cote = parseFloat(document.getElementById('cote').value) || 0;
    const id = Date.now();
    const op = {id,type,bookmaker,dateOperation,heureOperation,mise,cote,statut:'En cours'};
    operations.unshift(op);
  } else {
    const montant = parseFloat(document.getElementById('montant').value) || 0;
    const id = Date.now();
    const op = {id,type,bookmaker,dateOperation,heureOperation,montant,statut:'OK'};
    operations.unshift(op);
  }
  saveDataToLocalStorage();
  if(firebaseInitialized && currentUser) saveDataToFirebase();
  updateUI();
  activateTabByName('suivi-operations');
}

function resetOperationForm(){
  document.getElementById('mise').value=''; document.getElementById('cote').value=''; document.getElementById('match').value=''; calcGain();
}

function editOperation(id){
  const op = operations.find(o=>o.id===id);
  if(!op) return;
  activateTabByName('enregistrer');
  document.getElementById('operationType').value = op.type;
  document.getElementById('operationBookmaker').value = op.bookmaker||'';
  document.getElementById('dateOperation').value = op.dateOperation||'';
  document.getElementById('heureOperation').value = op.heureOperation||'';
  if(op.type==='Pari'){ document.getElementById('mise').value = op.mise; document.getElementById('cote').value = op.cote; calcGain(); }
}

function deleteOperation(id){
  if(!confirm('Supprimer cette op√©ration ?')) return;
  operations = operations.filter(o=>o.id!==id);
  saveDataToLocalStorage();
  if(firebaseInitialized && currentUser) saveDataToFirebase();
  updateUI();
}

// ----- BOOKMAKERS / TIPSTERS -----
function saveBookmaker(){
  const nom = document.getElementById('bookmakerNom').value.trim();
  const solde = parseFloat(document.getElementById('bookmakerSolde').value) || 0;
  if(!nom) return alert('Nom requis');
  const id = Date.now();
  bookmakers.push({id,nom,soldeInitial:solde});
  saveDataToLocalStorage(); if(firebaseInitialized && currentUser) saveDataToFirebase();
  updateUI();
  document.getElementById('bookmakerNom').value=''; document.getElementById('bookmakerSolde').value='';
}

// ----- IMPORT / EXPORT / RESET -----
function exportData(){
  const data = {bookmakers,operations,tipsters,exportDate:new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='bankroll-backup.json'; a.click(); URL.revokeObjectURL(url);
  alert('Export√©');
}
function importData(e){
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = function(ev){
    try{
      const data = JSON.parse(ev.target.result);
      if(!confirm('Importer et remplacer ?')) return;
      bookmakers = data.bookmakers||[]; operations = data.operations||[]; tipsters = data.tipsters||[];
      saveDataToLocalStorage(); if(firebaseInitialized && currentUser) saveDataToFirebase();
      updateUI();
      alert('Import OK');
    }catch(err){ alert('Fichier invalide'); }
  };
  r.readAsText(file);
}
function resetApp(){
  if(!confirm('Tout supprimer ?')) return;
  bookmakers = []; operations = []; tipsters = [];
  saveDataToLocalStorage(); updateUI();
}

// ----- STARTUP -----
window.addEventListener('DOMContentLoaded', function(){
  setupEvents();
  loadDataFromLocalStorage();
  updateUI();
  initializeApp();
});
</script>
</body>
</html>
