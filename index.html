<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de bankroll</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .tabs { background: white; border-radius: 12px 12px 0 0; display: flex; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tab-button { flex: 1; padding: 18px 20px; background: white; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-button:hover { background: #f9fafb; color: #3b82f6; }
        .tab-button.active { color: #3b82f6; border-bottom-color: #3b82f6; background: #eff6ff; }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .card-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
        .card-description { color: #6b7280; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; position: relative; }
        label { font-weight: 600; margin-bottom: 8px; color: #374151; }
        input, select { padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-info { background: #06b6d4; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.875rem; }
        .btn-block { width: 100%; }
        .gain-display { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 15px; border-radius: 8px; font-size: 1.5rem; font-weight: 700; text-align: center; }
        .autocomplete-container { position: relative; }
        .autocomplete-results { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #3b82f6; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .autocomplete-results.active { display: block; }
        .autocomplete-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .autocomplete-item:hover { background: #eff6ff; }
        .match-info { font-weight: 600; color: #1f2937; }
        .match-meta { font-size: 0.875rem; color: #6b7280; margin-top: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th { background: #f9fafb; padding: 12px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        td { padding: 12px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        tr:hover { background: #f9fafb; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fed7aa; color: #9a3412; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f3f4f6; color: #374151; }
        .bookmaker-list { display: grid; gap: 15px; margin-bottom: 20px; }
        .bookmaker-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb; }
        .bookmaker-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .bookmaker-balance { color: #6b7280; }
        .bookmaker-current { font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin-right: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 25px; border-radius: 12px; }
        .stat-card.green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .stat-label { font-size: 0.95rem; opacity: 0.9; margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .action-buttons { display: flex; gap: 4px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .edit-mode-banner { background: #fef3c7; color: #92400e; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; text-align: center; }
        .reset-zone { margin-top: 30px; padding-top: 30px; border-top: 2px solid #fee2e2; }
        .export-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tipster-card { background: #f9fafb; padding: 20px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; }
        .tipster-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .tipster-card.selected { border-color: #3b82f6; background: #eff6ff; }
        .tipster-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tipster-name { font-size: 1.3rem; font-weight: 700; color: #1f2937; }
        .tipster-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9rem; }
        .tipster-stat { text-align: center; }
        .tipster-stat-value { font-weight: 700; color: #3b82f6; }
        .tipster-stat-label { color: #6b7280; font-size: 0.85rem; }
        .sport-icon { width: 20px; height: 20px; display: inline-block; text-align: center; font-weight: bold; margin-right: 5px; }
        
        /* Styles pour Firebase Auth */
        .auth-container { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .user-info { background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .sync-status { position: fixed; top: 20px; right: 20px; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 0.9rem; }
        .sync-status.syncing { background: #fef3c7; color: #92400e; }
        .sync-status.synced { background: #dcfce7; color: #166534; }
        .sync-status.error { background: #fee2e2; color: #991b1b; }
        .offline-mode { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barre de statut de synchronisation -->
        <div class="sync-status" id="syncStatus" style="display: none;">
            üîÑ Synchronisation...
        </div>

        <div class="header">
            <h1>üí∞ Suivi de bankroll</h1>
            <p>G√©rez vos paris sportifs et suivez vos performances</p>
        </div>

        <!-- Section Authentification -->
        <div class="auth-container" id="authContainer">
            <h2>üîê Connexion</h2>
            <p>Connectez-vous pour synchroniser vos donn√©es sur tous vos appareils</p>
            <div class="form-grid" style="max-width: 400px; margin: 20px auto;">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="authEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="authPassword" placeholder="Votre mot de passe">
                </div>
            </div>
            <button class="btn btn-primary" onclick="login()">Se connecter</button>
            <button class="btn btn-secondary" onclick="signup()">Cr√©er un compte</button>
            <div style="margin-top: 15px; font-size: 0.9rem; color: #6b7280;">
                <p>Ou utilisez un compte anonyme :</p>
                <button class="btn btn-info btn-sm" onclick="loginAnonymously()">Utiliser sans compte</button>
            </div>
        </div>

        <!-- Info utilisateur connect√© -->
        <div class="user-info" id="userInfo" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Connect√© en tant que :</strong> 
                    <span id="userEmail"></span>
                    <span id="userAnonymous" style="font-style: italic; color: #6b7280;"></span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <!-- Le reste de votre application -->
        <div class="tabs" id="mainTabs" style="display: none;">
            <button class="tab-button active" data-tab="enregistrer">Enregistrer</button>
            <button class="tab-button" data-tab="suivi-operations">Suivi des op√©rations</button>
            <button class="tab-button" data-tab="tipsters">Tipsters</button>
            <button class="tab-button" data-tab="bookmakers">Bookmakers</button>
            <button class="tab-button" data-tab="statistiques">Statistiques</button>
            <button class="tab-button" data-tab="outils">Outils</button>
            <button class="tab-button" data-tab="reglages">R√©glages</button>
        </div>
        
        <!-- Onglet Enregistrer -->
        <div class="tab-content active" id="enregistrer" style="display: none;">
            <div class="card">
                <div id="editModeBanner" class="edit-mode-banner" style="display: none;">
                    üìù Mode modification activ√© - Les donn√©es actuelles sont conserv√©es
                </div>
                <h2 class="card-title">Enregistrer une op√©ration</h2>
                <p class="card-description">Ajoutez un nouveau pari, d√©p√¥t, retrait ou frais</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Type d'op√©ration</label>
                        <select id="operationType">
                            <option value="Pari">Pari</option>
                            <option value="D√©p√¥t">D√©p√¥t</option>
                            <option value="Retrait">Retrait</option>
                            <option value="Frais">Frais</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bookmaker</label>
                        <select id="operationBookmaker"><option value="">S√©lectionner un bookmaker</option></select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="dateOperation" value="">
                    </div>
                    <div class="form-group">
                        <label>Heure</label>
                        <input type="time" id="heureOperation" value="">
                    </div>
                </div>
                <div id="pariFields">
                    <div class="form-group">
                        <label>Tipster (optionnel)</label>
                        <select id="operationTipster">
                            <option value="">Aucun / Personnel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rechercher un match</label>
                        <div class="autocomplete-container">
                            <input type="text" id="matchSearch" placeholder="Tapez le nom d'une √©quipe (ex: Barnsley, PSG...)">
                            <div class="autocomplete-results" id="autocompleteResults"></div>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Sport</label>
                            <input type="text" id="sport" placeholder="Football, Tennis...">
                        </div>
                        <div class="form-group">
                            <label>Match</label>
                            <input type="text" id="match" placeholder="PSG vs OM">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>√âquipe / S√©lection</label><input type="text" id="selection" placeholder="PSG"></div>
                        <div class="form-group">
                            <label>Type de pari</label>
                            <select id="typePari">
                                <option value="Simple">Simple</option>
                                <option value="Multiple">Multiple</option>
                                <option value="Score exact">Score exact</option>
                                <option value="Points">Points</option>
                                <option value="Marqueur">Marqueur</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Mise (‚Ç¨)</label><input type="number" id="mise" step="0.01" placeholder="0.00"></div>
                        <div class="form-group"><label>C√¥te</label><input type="number" id="cote" step="0.01" placeholder="1.50"></div>
                        <div class="form-group"><label>Gain net (‚Ç¨)</label><div class="gain-display" id="gainPotentiel">0.00 ‚Ç¨</div></div>
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="statut">
                            <option value="En cours">En cours</option>
                            <option value="Gagn√©">Gagn√©</option>
                            <option value="Perdu">Perdu</option>
                            <option value="Rembours√©">Rembours√©</option>
                        </select>
                    </div>
                </div>
                <div id="depotRetraitFields" style="display: none;">
                    <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" id="montant" step="0.01" placeholder="0.00"></div>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveOperation()">Enregistrer</button>
                <button id="cancelEditBtn" class="btn btn-secondary btn-block" onclick="cancelEdit()" style="display: none; margin-top: 10px;">Annuler la modification</button>
            </div>
        </div>
        
        <!-- Onglet Suivi des op√©rations -->
        <div class="tab-content" id="suivi-operations" style="display: none;">
            <div class="card">
                <h2 class="card-title">Suivi des op√©rations</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date/Heure</th>
                                <th>Type</th>
                                <th>Bookmaker</th>
                                <th>Sport</th>
                                <th>Match</th>
                                <th>√âquipe/S√©lection</th>
                                <th>Type pari</th>
                                <th>Tipster</th>
                                <th>Mise</th>
                                <th>C√¥te</th>
                                <th>Statut</th>
                                <th>R√©sultat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTableBody">
                            <tr><td colspan="13" style="text-align: center; color: #9ca3af; padding: 40px;">Aucune op√©ration</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Onglet Tipsters -->
        <div class="tab-content" id="tipsters" style="display: none;">
            <div class="card">
                <h2 class="card-title">Tipsters</h2>
                <p class="card-description">G√©rez vos tipsters et suivez leurs performances</p>
                <div id="tipsterList"></div>
                <button class="btn btn-primary" onclick="showTipsterForm()">Ajouter un tipster</button>
                <div id="tipsterFormContainer" style="display: none; margin-top: 20px;">
                    <h3 id="tipsterFormTitle">Nouveau Tipster</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Nom du tipster</label><input type="text" id="tipsterNom"></div>
                        <div class="form-group"><label>Description (optionnel)</label><input type="text" id="tipsterDescription" placeholder="Ex: Twitter @pseudo"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveTipster()">Enregistrer</button>
                    <button class="btn btn-secondary" onclick="cancelTipsterForm()">Annuler</button>
                </div>
                <div id="tipsterDetailsContainer" style="display: none; margin-top: 30px;">
                    <h3 id="tipsterDetailsTitle"></h3>
                    <div class="stats-grid" id="tipsterDetailsStats"></div>
                    <button class="btn btn-secondary" onclick="closeTipsterDetails()">Retour</button>
                </div>
            </div>
        </div>
        
        <!-- Onglet Bookmakers -->
        <div class="tab-content" id="bookmakers" style="display: none;">
            <div class="card">
                <h2 class="card-title">Bookmakers</h2>
                <div class="bookmaker-list" id="bookmakerList"></div>
                <button class="btn btn-primary" onclick="showBookmakerForm()">Ajouter un bookmaker</button>
                <div id="bookmakerFormContainer" style="display: none; margin-top: 20px;">
                    <h3 id="bookmakerFormTitle">Nouveau Bookmaker</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Nom</label><input type="text" id="bookmakerNom"></div>
                        <div class="form-group"><label>Solde initial (‚Ç¨)</label><input type="number" id="bookmakerSolde" step="0.01"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveBookmaker()">Enregistrer</button>
                    <button class="btn btn-secondary" onclick="cancelBookmakerForm()">Annuler</button>
                </div>
            </div>
        </div>
        
        <!-- Onglet Statistiques -->
        <div class="tab-content" id="statistiques" style="display: none;">
            <div class="card">
                <h2 class="card-title">Statistiques</h2>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
        
        <!-- Onglet Outils -->
        <div class="tab-content" id="outils" style="display: none;">
            <div class="card">
                <h2 class="card-title">üõ†Ô∏è Outils</h2>
                <p class="card-description">Section en construction - Bient√¥t de nouvelles fonctionnalit√©s !</p>
                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üîß</div>
                    <h3 style="margin-bottom: 10px;">Fonctionnalit√©s √† venir</h3>
                    <p>Nous travaillons sur de nouveaux outils pour am√©liorer votre exp√©rience.</p>
                </div>
            </div>
        </div>
        
        <!-- Onglet R√©glages -->
        <div class="tab-content" id="reglages" style="display: none;">
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è R√©glages</h2>
                <p class="card-description">G√©rez vos donn√©es et param√®tres</p>
                
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportData()">üì• Exporter les donn√©es</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì§ Importer les donn√©es</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
                
                <div class="reset-zone">
                    <h3 style="color: #dc2626; margin-bottom: 15px;">‚ö†Ô∏è Zone dangereuse</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">Cette action supprimera toutes vos donn√©es de mani√®re irr√©versible.</p>
                    <button class="btn btn-danger" onclick="resetApp()">üóëÔ∏è R√©initialiser l'application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cash-out -->
    <div class="modal" id="cashoutModal">
        <div class="modal-content">
            <div class="modal-header">üí∞ Cash-out</div>
            <div class="form-group">
                <label>Montant du cash-out (‚Ç¨)</label>
                <input type="number" id="cashoutAmount" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="confirmCashout()">Valider</button>
                <button class="btn btn-secondary" onclick="closeCashoutModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION FIREBASE ===
        // REMPLACEZ CES VALEURS PAR VOS PROPRES CL√âS FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDbtGDuOVE4lYkVtLjZ0AnrpbWVnwcdvZI",
            authDomain: "bankroll-suivi.firebaseapp.com",
            databaseURL: "https://bankroll-suivi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bankroll-suivi",
            storageBucket: "bankroll-suivi.firebasestorage.app",
            messagingSenderId: "632546496211",
            appId: "1:632546496211:web:25375f3e496c4a43490e26"
        };

        // Initialisation Firebase avec gestion d'erreur
        let auth, database;
        let isOnline = true;
        
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            console.log('Firebase initialis√© avec succ√®s');
        } catch (error) {
            console.error('Erreur initialisation Firebase:', error);
            showOfflineMode();
        }

        // Variables globales
        let bookmakers = [];
        let operations = [];
        let tipsters = [];
        let searchTimeout = null;
        let currentCashoutId = null;
        let editingOperationId = null;
        let editingTipsterId = null;
        let editingBookmakerId = null;
        let isSyncing = false;
        let currentUser = null;

        const mockMatches = [
            {sport: 'Football', home: 'Barnsley', away: 'Lincoln', date: '2025-11-15', time: '20:00'},
            {sport: 'Football', home: 'PSG', away: 'OM', date: '2025-11-16', time: '21:00'},
            {sport: 'Football', home: 'Real Madrid', away: 'Barcelona', date: '2025-11-17', time: '20:00'},
            {sport: 'Football', home: 'Manchester United', away: 'Liverpool', date: '2025-11-18', time: '17:30'},
            {sport: 'Football', home: 'Bayern', away: 'Dortmund', date: '2025-11-19', time: '18:30'},
            {sport: 'Football', home: 'Arsenal', away: 'Chelsea', date: '2025-11-22', time: '16:00'}
        ];

        const sportIcons = {
            'Football': '‚öΩ', 'Basketball': 'üèÄ', 'Tennis': 'üéæ', 'Rugby': 'üèâ',
            'Hockey': 'üèí', 'Volley': 'üèê', 'F1': 'üèéÔ∏è', 'Baseball': '‚öæ',
            'Golf': '‚õ≥', 'Boxe': 'ü•ä'
        };

        // === NOUVELLES FONCTIONS POUR MOBILE ===
        function showOfflineMode() {
            isOnline = false;
            console.log('Mode hors ligne activ√©');
            
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = 'üì± Mode hors ligne - Donn√©es locales';
            statusEl.className = 'sync-status offline-mode';
            statusEl.style.display = 'block';
            
            loadDataFromLocalStorage();
            updateUI();
            
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('mainTabs').style.display = 'flex';
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById('enregistrer').style.display = 'block';
        }

        function setupNetworkDetection() {
            window.addEventListener('online', function() {
                isOnline = true;
                showSyncStatus('‚úÖ Connexion r√©tablie', 'synced');
                if (currentUser && auth) {
                    setTimeout(() => saveDataToFirebase(), 1000);
                }
            });
            
            window.addEventListener('offline', function() {
                isOnline = false;
                showSyncStatus('üì± Mode hors ligne', 'offline-mode');
            });
        }

        // === GESTION AUTHENTIFICATION AM√âLIOR√âE ===
        function showAuthUI() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('mainTabs').style.display = 'none';
        }

        function showAppUI(user) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('mainTabs').style.display = 'flex';
            
            const userEmail = document.getElementById('userEmail');
            const userAnonymous = document.getElementById('userAnonymous');
            
            if (user.isAnonymous) {
                userEmail.textContent = '';
                userAnonymous.textContent = 'Compte anonyme';
            } else {
                userEmail.textContent = user.email;
                userAnonymous.textContent = '';
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById('enregistrer').style.display = 'block';
            
            loadUserData();
        }

        async function login() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            try {
                showSyncStatus('üîÑ Connexion...', 'syncing');
                await auth.signInWithEmailAndPassword(email, password);
                showSyncStatus('‚úÖ Connect√©', 'synced');
            } catch (error) {
                console.error('Erreur connexion:', error);
                let errorMessage = 'Erreur de connexion: ';
                
                if (error.code === 'auth/network-request-failed') {
                    errorMessage += 'Probl√®me de connexion r√©seau. V√©rifiez votre internet';
                    if (!auth) showOfflineMode();
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage += 'Aucun compte trouv√© avec cet email';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Mot de passe incorrect';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage += 'Trop de tentatives. R√©essayez plus tard';
                } else {
                    errorMessage += error.message;
                }
                alert(errorMessage);
            }
        }

        async function signup() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (password.length < 6) {
                alert('Le mot de passe doit contenir au moins 6 caract√®res');
                return;
            }
            
            try {
                showSyncStatus('üîÑ Cr√©ation du compte...', 'syncing');
                await auth.createUserWithEmailAndPassword(email, password);
                showSyncStatus('‚úÖ Compte cr√©√©', 'synced');
            } catch (error) {
                console.error('Erreur cr√©ation compte:', error);
                let errorMessage = 'Erreur de cr√©ation de compte: ';
                
                if (error.code === 'auth/network-request-failed') {
                    errorMessage += 'Probl√®me de connexion r√©seau. V√©rifiez votre internet';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'Un compte existe d√©j√† avec cet email';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'Adresse email invalide';
                } else {
                    errorMessage += error.message;
                }
                alert(errorMessage);
            }
        }

        async function loginAnonymously() {
            try {
                showSyncStatus('üîÑ Connexion...', 'syncing');
                await auth.signInAnonymously();
                showSyncStatus('‚úÖ Session anonyme d√©marr√©e', 'synced');
            } catch (error) {
                console.error('Erreur connexion anonyme:', error);
                if (error.code === 'auth/network-request-failed') {
                    alert('Probl√®me de connexion r√©seau. V√©rifiez votre internet');
                    showOfflineMode();
                } else {
                    alert('Erreur de connexion anonyme: ' + error.message);
                }
            }
        }

        async function logout() {
            try {
                await saveDataToFirebase();
                await auth.signOut();
                showAuthUI();
            } catch (error) {
                alert('Erreur de d√©connexion: ' + error.message);
            }
        }

        // === GESTION DES DONN√âES FIREBASE AM√âLIOR√âE ===
        function getUserDataPath() {
            if (!currentUser) return null;
            return `users/${currentUser.uid}`;
        }

        async function saveDataToFirebase() {
            if (!currentUser || isSyncing || !isOnline || !database) return;
            
            isSyncing = true;
            showSyncStatus('üîÑ Synchronisation...', 'syncing');
            
            try {
                const userDataPath = getUserDataPath();
                const data = {
                    bookmakers: bookmakers,
                    operations: operations,
                    tipsters: tipsters,
                    lastSync: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(userDataPath).set(data);
                showSyncStatus('‚úÖ Donn√©es synchronis√©es', 'synced');
                
                saveDataToLocalStorage();
            } catch (error) {
                console.error('Erreur synchronisation:', error);
                if (error.code === 'NETWORK_ERROR' || error.message.includes('network')) {
                    showSyncStatus('üì± Mode hors ligne', 'offline-mode');
                    isOnline = false;
                } else {
                    showSyncStatus('‚ùå Erreur synchronisation', 'error');
                }
            } finally {
                setTimeout(() => {
                    isSyncing = false;
                    document.getElementById('syncStatus').style.display = 'none';
                }, 2000);
            }
        }

        async function loadUserData() {
            if (!currentUser || !database) {
                loadDataFromLocalStorage();
                updateUI();
                return;
            }
            
            showSyncStatus('üîÑ Chargement...', 'syncing');
            
            try {
                const userDataPath = getUserDataPath();
                const snapshot = await database.ref(userDataPath).once('value');
                const data = snapshot.val();
                
                if (data) {
                    bookmakers = data.bookmakers || [];
                    operations = data.operations || [];
                    tipsters = data.tipsters || [];
                    showSyncStatus('‚úÖ Donn√©es charg√©es', 'synced');
                } else {
                    loadDataFromLocalStorage();
                    await saveDataToFirebase();
                }
                
                updateUI();
            } catch (error) {
                console.error('Erreur chargement:', error);
                loadDataFromLocalStorage();
                updateUI();
                showSyncStatus('‚ö†Ô∏è Donn√©es locales charg√©es', 'synced');
                
                if (error.code === 'NETWORK_ERROR' || error.message.includes('network')) {
                    showOfflineMode();
                }
            }
        }

        function showSyncStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.className = `sync-status ${type}`;
            statusEl.style.display = 'block';
        }

        // === FONCTIONS EXISTANTES MODIFI√âES ===
        function saveData() {
            saveDataToLocalStorage();
            if (currentUser && isOnline) {
                saveDataToFirebase();
            }
        }

        function saveDataToLocalStorage() {
            localStorage.setItem('bookmakers', JSON.stringify(bookmakers));
            localStorage.setItem('operations', JSON.stringify(operations));
            localStorage.setItem('tipsters', JSON.stringify(tipsters));
        }

        function loadDataFromLocalStorage() {
            const saved = localStorage.getItem('bookmakers');
            if (saved) { 
                bookmakers = JSON.parse(saved); 
            } else {
                bookmakers = [
                    {id: 1, nom: 'Loro', soldeInitial: 100},
                    {id: 2, nom: 'bet365', soldeInitial: 100},
                    {id: 3, nom: 'Betclic', soldeInitial: 100}
                ];
            }
            
            const ops = localStorage.getItem('operations');
            if (ops) operations = JSON.parse(ops);
            
            const tips = localStorage.getItem('tipsters');
            if (tips) tipsters = JSON.parse(tips);
        }

        function updateUI() {
            updateSelects();
            renderBookmakers();
            renderOperations();
            renderTipsters();
            renderStats();
            
            const now = new Date();
            document.getElementById('dateOperation').value = now.toISOString().split('T')[0];
            document.getElementById('heureOperation').value = now.toTimeString().slice(0, 5);
        }

        // === √âCOUTEUR D'AUTHENTIFICATION AM√âLIOR√â ===
        if (auth) {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                if (user) {
                    showAppUI(user);
                } else {
                    showAuthUI();
                }
            }, (error) => {
                console.error('Erreur auth state changed:', error);
                showOfflineMode();
            });
        } else {
            showOfflineMode();
        }

        // === INITIALISATION ===
        window.addEventListener('DOMContentLoaded', function() {
            loadDataFromLocalStorage();
            setupEvents();
            setupNetworkDetection();
            
            if (!auth) {
                showOfflineMode();
            }
        });

        // === VOS FONCTIONS EXISTANTES (elles restent identiques) ===
        function setupEvents() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button, .tab-content').forEach(el => {
                        el.classList.remove('active');
                        if (el.classList.contains('tab-content')) {
                            el.style.display = 'none';
                        }
                    });
                    this.classList.add('active');
                    const tabContent = document.getElementById(this.dataset.tab);
                    tabContent.classList.add('active');
                    tabContent.style.display = 'block';
                    
                    if (this.dataset.tab === 'statistiques') renderStats();
                    if (this.dataset.tab === 'bookmakers') renderBookmakers();
                    if (this.dataset.tab === 'suivi-operations') renderOperations();
                    if (this.dataset.tab === 'tipsters') renderTipsters();
                });
            });

            document.getElementById('operationType').addEventListener('change', function() {
                if (this.value === 'Pari') {
                    document.getElementById('pariFields').style.display = 'block';
                    document.getElementById('depotRetraitFields').style.display = 'none';
                } else {
                    document.getElementById('pariFields').style.display = 'none';
                    document.getElementById('depotRetraitFields').style.display = 'block';
                }
            });

            document.getElementById('mise').addEventListener('input', calcGain);
            document.getElementById('cote').addEventListener('input', calcGain);

            document.getElementById('matchSearch').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const q = this.value.toLowerCase();
                if (q.length < 2) {
                    document.getElementById('autocompleteResults').classList.remove('active');
                    return;
                }
                searchTimeout = setTimeout(() => {
                    const results = mockMatches.filter(m => m.home.toLowerCase().includes(q) || m.away.toLowerCase().includes(q));
                    showResults(results);
                }, 300);
            });

            document.getElementById('sport').addEventListener('input', function() {
                const value = this.value;
                if (value.length === 1) {
                    const completed = autoCompleteSport(value);
                    if (completed !== value) {
                        this.value = completed;
                    }
                }
            });
        }

        function autoCompleteSport(input) {
            const sportMap = {
                'F': 'Football', 'B': 'Basketball', 'V': 'Volley', 
                'R': 'Rugby', '1': 'F1', 'H': 'Hockey'
            };
            return sportMap[input.toUpperCase()] || input;
        }

        function updateSelects() {
            const bookHtml = bookmakers.map(b => `<option value="${b.nom}">${b.nom}</option>`).join('');
            document.getElementById('operationBookmaker').innerHTML = '<option value="">S√©lectionner</option>' + bookHtml;
            
            const tipHtml = tipsters.map(t => `<option value="${t.id}">${t.nom}</option>`).join('');
            document.getElementById('operationTipster').innerHTML = '<option value="">Aucun / Personnel</option>' + tipHtml;
        }

        function calcGain() {
            const mise = parseFloat(document.getElementById('mise').value) || 0;
            const cote = parseFloat(document.getElementById('cote').value) || 0;
            const gainNet = (mise * cote) - mise;
            document.getElementById('gainPotentiel').textContent = gainNet.toFixed(2) + ' ‚Ç¨';
        }

        function showResults(results) {
            const container = document.getElementById('autocompleteResults');
            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 12px 15px; color: #9ca3af;">Aucun r√©sultat</div>';
            } else {
                container.innerHTML = results.map(m => `<div class="autocomplete-item" onclick='selectMatch(${JSON.stringify(m)})'><div class="match-info">‚öΩ ${m.home} vs ${m.away}</div><div class="match-meta">${m.date} √† ${m.time}</div></div>`).join('');
            }
            container.classList.add('active');
        }

        function selectMatch(match) {
            document.getElementById('sport').value = match.sport;
            document.getElementById('match').value = `${match.home} vs ${match.away}`;
            document.getElementById('dateOperation').value = match.date;
            document.getElementById('heureOperation').value = match.time;
            document.getElementById('selection').value = match.home;
            document.getElementById('matchSearch').value = `${match.home} vs ${match.away}`;
            document.getElementById('autocompleteResults').classList.remove('active');
        }

        function saveOperation() {
            const type = document.getElementById('operationType').value;
            const bookmaker = document.getElementById('operationBookmaker').value;
            if (!bookmaker) { alert('Veuillez s√©lectionner un bookmaker'); return; }
            
            let op;
            if (editingOperationId) {
                op = operations.find(o => o.id === editingOperationId);
                if (!op) return;
            } else {
                op = { id: Date.now() };
                operations.push(op);
            }
            
            const dateOp = document.getElementById('dateOperation').value;
            const heureOp = document.getElementById('heureOperation').value;
            op.dateOperation = dateOp || new Date().toISOString().split('T')[0];
            op.heureOperation = heureOp || new Date().toTimeString().slice(0, 5);
            op.dateCreation = new Date().toISOString();
            
            op.type = type;
            op.bookmaker = bookmaker;
            
            if (type === 'Pari') {
                const mise = document.getElementById('mise').value;
                const cote = document.getElementById('cote').value;
                if (!mise || !cote) { alert('Remplissez mise et c√¥te'); return; }
                op.sport = document.getElementById('sport').value;
                op.match = document.getElementById('match').value;
                op.mise = parseFloat(mise);
                op.cote = parseFloat(cote);
                op.statut = document.getElementById('statut').value;
                op.tipster = document.getElementById('operationTipster').value;
                op.typePari = document.getElementById('typePari').value;
                op.selection = document.getElementById('selection').value;
            } else {
                const montant = document.getElementById('montant').value;
                if (!montant) { alert('Saisissez un montant'); return; }
                op.montant = parseFloat(montant);
            }
            
            saveData();
            alert(editingOperationId ? '‚úÖ Op√©ration modifi√©e !' : '‚úÖ Op√©ration enregistr√©e !');
            resetForm();
            renderOperations();
            renderBookmakers();
            renderTipsters();
            renderStats();
        }

        function resetForm() {
            editingOperationId = null;
            document.getElementById('editModeBanner').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('operationType').value = 'Pari';
            document.getElementById('operationBookmaker').selectedIndex = 0;
            document.getElementById('operationTipster').selectedIndex = 0;
            document.getElementById('matchSearch').value = '';
            document.getElementById('sport').value = '';
            document.getElementById('match').value = '';
            document.getElementById('selection').value = '';
            document.getElementById('mise').value = '';
            document.getElementById('cote').value = '';
            document.getElementById('montant').value = '';
            document.getElementById('typePari').value = 'Simple';
            document.getElementById('gainPotentiel').textContent = '0.00 ‚Ç¨';
            document.getElementById('pariFields').style.display = 'block';
            document.getElementById('depotRetraitFields').style.display = 'none';
            
            const now = new Date();
            document.getElementById('dateOperation').value = now.toISOString().split('T')[0];
            document.getElementById('heureOperation').value = now.toTimeString().slice(0, 5);
        }

        function cancelEdit() {
            resetForm();
        }

        function updateOperationStatus(id, newStatus) {
            const op = operations.find(o => o.id === id);
            if (op && op.type === 'Pari') {
                op.statut = newStatus;
                saveData();
                renderOperations();
                renderBookmakers();
                renderTipsters();
                renderStats();
            }
        }

        function showCashoutModal(id) {
            currentCashoutId = id;
            document.getElementById('cashoutAmount').value = '';
            document.getElementById('cashoutModal').classList.add('active');
        }

        function closeCashoutModal() {
            document.getElementById('cashoutModal').classList.remove('active');
            currentCashoutId = null;
        }

        function confirmCashout() {
            const amount = parseFloat(document.getElementById('cashoutAmount').value);
            if (!amount || amount <= 0) {
                alert('Saisissez un montant valide');
                return;
            }
            const op = operations.find(o => o.id === currentCashoutId);
            if (op && op.type === 'Pari') {
                op.statut = 'Cash-out';
                op.cashoutAmount = amount;
                saveData();
                renderOperations();
                renderBookmakers();
                renderTipsters();
                renderStats();
                closeCashoutModal();
            }
        }

        function deleteOperation(id) {
            if (confirm('Supprimer cette op√©ration ?')) {
                operations = operations.filter(o => o.id !== id);
                saveData();
                renderOperations();
                renderBookmakers();
                renderTipsters();
                renderStats();
            }
        }

        function editOperation(id) {
            const op = operations.find(o => o.id === id);
            if (!op) return;
            
            editingOperationId = id;
            document.getElementById('editModeBanner').style.display = 'block';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            document.querySelectorAll('.tab-button, .tab-content').forEach(el => {
                el.classList.remove('active');
                if (el.classList.contains('tab-content')) {
                    el.style.display = 'none';
                }
            });
            document.querySelector('[data-tab="enregistrer"]').classList.add('active');
            document.getElementById('enregistrer').classList.add('active');
            document.getElementById('enregistrer').style.display = 'block';
            
            document.getElementById('operationType').value = op.type;
            document.getElementById('operationBookmaker').value = op.bookmaker;
            document.getElementById('dateOperation').value = op.dateOperation || '';
            document.getElementById('heureOperation').value = op.heureOperation || '';
            
            if (op.type === 'Pari') {
                document.getElementById('pariFields').style.display = 'block';
                document.getElementById('depotRetraitFields').style.display = 'none';
                document.getElementById('sport').value = op.sport || '';
                document.getElementById('match').value = op.match || '';
                document.getElementById('mise').value = op.mise;
                document.getElementById('cote').value = op.cote;
                document.getElementById('statut').value = op.statut;
                document.getElementById('operationTipster').value = op.tipster || '';
                document.getElementById('typePari').value = op.typePari || 'Simple';
                document.getElementById('selection').value = op.selection || '';
                calcGain();
            } else {
                document.getElementById('pariFields').style.display = 'none';
                document.getElementById('depotRetraitFields').style.display = 'block';
                document.getElementById('montant').value = op.montant;
            }
        }

        function renderOperations() {
            const tbody = document.getElementById('operationsTableBody');
            if (operations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; color: #9ca3af; padding: 40px;">Aucune op√©ration</td></tr>';
                return;
            }

            const sortedOperations = [...operations].sort((a, b) => {
                const dateA = new Date(a.dateOperation + 'T' + (a.heureOperation || '00:00'));
                const dateB = new Date(b.dateOperation + 'T' + (b.heureOperation || '00:00'));
                return dateB - dateA;
            });

            tbody.innerHTML = sortedOperations.map(op => {
                let resultat = '-';
                if (op.type === 'Pari') {
                    if (op.statut === 'Gagn√©') resultat = '+' + (op.mise * op.cote - op.mise).toFixed(2) + '‚Ç¨';
                    else if (op.statut === 'Perdu') resultat = '-' + op.mise.toFixed(2) + '‚Ç¨';
                    else if (op.statut === 'Rembours√©') resultat = '0‚Ç¨';
                    else if (op.statut === 'Cash-out') resultat = '+' + (op.cashoutAmount - op.mise).toFixed(2) + '‚Ç¨';
                } else if (op.type === 'Frais') {
                    resultat = '-' + op.montant.toFixed(2) + '‚Ç¨';
                } else {
                    resultat = (op.type === 'D√©p√¥t' ? '+' : '-') + op.montant.toFixed(2) + '‚Ç¨';
                }
                
                let badge = 'badge-info';
                if (op.statut === 'Gagn√©') badge = 'badge-success';
                else if (op.statut === 'Perdu') badge = 'badge-danger';
                else if (op.statut === 'En cours') badge = 'badge-warning';
                else if (op.statut === 'Cash-out') badge = 'badge-info';
                else if (op.type !== 'Pari') badge = 'badge-secondary';
                
                let tipsterName = '-';
                if (op.tipster) {
                    const tip = tipsters.find(t => t.id == op.tipster);
                    if (tip) tipsterName = tip.nom;
                }

                const sportIcon = sportIcons[op.sport] || 'üèÜ';
                const dateHeure = op.dateOperation + (op.heureOperation ? '<br><small>' + op.heureOperation + '</small>' : '');
                
                let actionsHtml = `
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editOperation(${op.id})" title="Modifier">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOperation(${op.id})" title="Supprimer">üóëÔ∏è</button>
                `;
                
                if (op.type === 'Pari' && op.statut === 'En cours') {
                    actionsHtml += `
                        <button class="btn btn-success btn-sm" onclick="updateOperationStatus(${op.id}, 'Gagn√©')" title="Gagn√©">‚úì</button>
                        <button class="btn btn-danger btn-sm" onclick="updateOperationStatus(${op.id}, 'Perdu')" title="Perdu">‚úó</button>
                        <button class="btn btn-warning btn-sm" onclick="updateOperationStatus(${op.id}, 'Rembours√©')" title="Rembours√©">‚Ü∫</button>
                        <button class="btn btn-info btn-sm" onclick="showCashoutModal(${op.id})" title="Cash-out">üí∞</button>
                    `;
                }
                
                actionsHtml += '</div>';
                
                return `
                    <tr>
                        <td>${dateHeure}</td>
                        <td>${op.type}</td>
                        <td>${op.bookmaker}</td>
                        <td>${op.sport ? `<span class="sport-icon">${sportIcon}</span> ${op.sport}` : '-'}</td>
                        <td>${op.match || '-'}</td>
                        <td>${op.selection || '-'}</td>
                        <td>${op.typePari || '-'}</td>
                        <td>${tipsterName}</td>
                        <td>${op.mise ? op.mise.toFixed(2) + '‚Ç¨' : '-'}</td>
                        <td>${op.cote || '-'}</td>
                        <td><span class="badge ${badge}">${op.statut || '-'}</span></td>
                        <td>${resultat}</td>
                        <td>${actionsHtml}</td>
                    </tr>`;
            }).join('');
        }

        function renderBookmakers() {
            const container = document.getElementById('bookmakerList');
            container.innerHTML = bookmakers.map(b => {
                const soldeActuel = calcBookmakerBalance(b.id);
                return `
                    <div class="bookmaker-item">
                        <div>
                            <div class="bookmaker-name">${b.nom}</div>
                            <div class="bookmaker-balance">Solde initial: ${b.soldeInitial.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div class="bookmaker-current">${soldeActuel.toFixed(2)}‚Ç¨</div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="editBookmaker(${b.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBookmaker(${b.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function calcBookmakerBalance(bookId) {
            const book = bookmakers.find(b => b.id === bookId);
            if (!book) return 0;
            let balance = book.soldeInitial;
            operations.filter(op => op.bookmaker === book.nom).forEach(op => {
                if (op.type === 'D√©p√¥t') balance += op.montant;
                else if (op.type === 'Retrait') balance -= op.montant;
                else if (op.type === 'Frais') balance -= op.montant;
                else if (op.type === 'Pari') {
                    if (op.statut === 'Gagn√©') balance += (op.mise * op.cote - op.mise);
                    else if (op.statut === 'Perdu') balance -= op.mise;
                    else if (op.statut === 'Cash-out') balance += (op.cashoutAmount - op.mise);
                    else if (op.statut === 'En cours') balance -= op.mise;
                }
            });
            return balance;
        }

        function showBookmakerForm() { 
            document.getElementById('bookmakerFormContainer').style.display = 'block';
            document.getElementById('bookmakerFormTitle').textContent = 'Nouveau Bookmaker';
            editingBookmakerId = null;
        }

        function cancelBookmakerForm() {
            document.getElementById('bookmakerFormContainer').style.display = 'none';
            document.getElementById('bookmakerNom').value = '';
            document.getElementById('bookmakerSolde').value = '';
            editingBookmakerId = null;
        }

        function editBookmaker(id) {
            const bookmaker = bookmakers.find(b => b.id === id);
            if (!bookmaker) return;
            
            document.getElementById('bookmakerNom').value = bookmaker.nom;
            document.getElementById('bookmakerSolde').value = bookmaker.soldeInitial;
            document.getElementById('bookmakerFormContainer').style.display = 'block';
            document.getElementById('bookmakerFormTitle').textContent = 'Modifier Bookmaker';
            
            editingBookmakerId = id;
        }

        function saveBookmaker() {
            const nom = document.getElementById('bookmakerNom').value;
            const solde = parseFloat(document.getElementById('bookmakerSolde').value);
            if (!nom || isNaN(solde)) { alert('Remplissez tous les champs'); return; }
            
            if (editingBookmakerId) {
                const bookmaker = bookmakers.find(b => b.id === editingBookmakerId);
                if (bookmaker) {
                    bookmaker.nom = nom;
                    bookmaker.soldeInitial = solde;
                }
            } else {
                bookmakers.push({id: Date.now(), nom: nom, soldeInitial: solde});
            }
            
            saveData();
            updateSelects();
            renderBookmakers();
            cancelBookmakerForm();
            alert('‚úÖ Bookmaker ' + (editingBookmakerId ? 'modifi√©' : 'ajout√©') + ' !');
        }

        function deleteBookmaker(id) {
            if (confirm('Supprimer ce bookmaker ?')) {
                bookmakers = bookmakers.filter(b => b.id !== id);
                saveData();
                updateSelects();
                renderBookmakers();
            }
        }

        function showTipsterForm() { 
            document.getElementById('tipsterFormContainer').style.display = 'block';
            document.getElementById('tipsterDetailsContainer').style.display = 'none';
            document.getElementById('tipsterFormTitle').textContent = 'Nouveau Tipster';
            editingTipsterId = null;
            document.getElementById('tipsterList').style.display = 'block';
        }

        function cancelTipsterForm() {
            document.getElementById('tipsterFormContainer').style.display = 'none';
            document.getElementById('tipsterNom').value = '';
            document.getElementById('tipsterDescription').value = '';
            editingTipsterId = null;
            document.getElementById('tipsterList').style.display = 'block';
        }

        function saveTipster() {
            const nom = document.getElementById('tipsterNom').value;
            const description = document.getElementById('tipsterDescription').value;
            if (!nom) { alert('Saisissez un nom'); return; }
            
            if (editingTipsterId) {
                const tipster = tipsters.find(t => t.id === editingTipsterId);
                if (tipster) {
                    tipster.nom = nom;
                    tipster.description = description;
                }
            } else {
                tipsters.push({id: Date.now(), nom: nom, description: description});
            }
            
            saveData();
            updateSelects();
            renderTipsters();
            cancelTipsterForm();
            alert('‚úÖ Tipster ' + (editingTipsterId ? 'modifi√©' : 'ajout√©') + ' !');
        }

        function editTipster(id) {
            const tipster = tipsters.find(t => t.id === id);
            if (!tipster) return;
            
            document.getElementById('tipsterNom').value = tipster.nom;
            document.getElementById('tipsterDescription').value = tipster.description || '';
            document.getElementById('tipsterFormContainer').style.display = 'block';
            document.getElementById('tipsterList').style.display = 'block';
            document.getElementById('tipsterFormTitle').textContent = 'Modifier Tipster';
            
            editingTipsterId = id;
        }

        function deleteTipster(id) {
            if (confirm('Supprimer ce tipster ?')) {
                tipsters = tipsters.filter(t => t.id !== id);
                saveData();
                updateSelects();
                renderTipsters();
            }
        }

        function renderTipsters() {
            const container = document.getElementById('tipsterList');
            if (tipsters.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Aucun tipster. Ajoutez-en un pour commencer !</p>';
                return;
            }
            container.innerHTML = tipsters.map(t => {
                const stats = calcTipsterStats(t.id);
                return `
                    <div class="tipster-card" onclick="showTipsterDetails(${t.id})">
                        <div class="tipster-header">
                            <div>
                                <div class="tipster-name">${t.nom}</div>
                                ${t.description ? `<div style="color: #6b7280; font-size: 0.9rem;">${t.description}</div>` : ''}
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); editTipster(${t.id})">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteTipster(${t.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="tipster-stats">
                            <div class="tipster-stat">
                                <div class="tipster-stat-value">${stats.totalParis}</div>
                                <div class="tipster-stat-label">Paris</div>
                            </div>
                            <div class="tipster-stat">
                                <div class="tipster-stat-value" style="color: ${stats.profit >= 0 ? '#22c55e' : '#ef4444'}">${stats.profit >= 0 ? '+' : ''}${stats.profit.toFixed(2)}‚Ç¨</div>
                                <div class="tipster-stat-label">Profit</div>
                            </div>
                            <div class="tipster-stat">
                                <div class="tipster-stat-value">${stats.winRate}%</div>
                                <div class="tipster-stat-label">Taux r√©ussite</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calcTipsterStats(tipsterId) {
            const paris = operations.filter(op => op.type === 'Pari' && op.tipster == tipsterId);
            const gagnes = paris.filter(p => p.statut === 'Gagn√©').length;
            const perdus = paris.filter(p => p.statut === 'Perdu').length;
            let profit = 0;
            paris.forEach(p => {
                if (p.statut === 'Gagn√©') profit += (p.mise * p.cote - p.mise);
                else if (p.statut === 'Perdu') profit -= p.mise;
                else if (p.statut === 'Cash-out') profit += (p.cashoutAmount - p.mise);
            });
            const winRate = (gagnes + perdus) > 0 ? ((gagnes / (gagnes + perdus)) * 100).toFixed(2) : 0;
            return { totalParis: paris.length, gagnes, perdus, profit, winRate };
        }

        function showTipsterDetails(tipsterId) {
            const tipster = tipsters.find(t => t.id === tipsterId);
            if (!tipster) return;
            
            const stats = calcTipsterStats(tipsterId);
            const totalMises = operations.filter(op => op.type === 'Pari' && op.tipster == tipsterId).reduce((sum, p) => sum + (p.mise || 0), 0);
            const roi = totalMises > 0 ? ((stats.profit / totalMises) * 100).toFixed(2) : 0;
            
            document.getElementById('tipsterDetailsTitle').textContent = `üìä Statistiques de ${tipster.nom}`;
            document.getElementById('tipsterDetailsStats').innerHTML = `
                <div class="stat-card purple"><div class="stat-label">Total paris</div><div class="stat-value">${stats.totalParis}</div></div>
                <div class="stat-card ${stats.profit >= 0 ? 'green' : 'red'}"><div class="stat-label">Profit/Perte</div><div class="stat-value">${stats.profit >= 0 ? '+' : ''}${stats.profit.toFixed(2)}‚Ç¨</div></div>
                <div class="stat-card"><div class="stat-label">ROI</div><div class="stat-value">${roi}%</div></div>
                <div class="stat-card"><div class="stat-label">Taux de r√©ussite</div><div class="stat-value">${stats.winRate}%</div></div>
                <div class="stat-card green"><div class="stat-label">Paris gagn√©s</div><div class="stat-value">${stats.gagnes}</div></div>
                <div class="stat-card red"><div class="stat-label">Paris perdus</div><div class="stat-value">${stats.perdus}</div></div>
            `;
            
            document.getElementById('tipsterFormContainer').style.display = 'none';
            document.getElementById('tipsterDetailsContainer').style.display = 'block';
            document.getElementById('tipsterList').style.display = 'none';
        }

        function closeTipsterDetails() {
            document.getElementById('tipsterDetailsContainer').style.display = 'none';
            document.getElementById('tipsterList').style.display = 'block';
        }

        function resetApp() {
            if (confirm('‚ö†Ô∏è ATTENTION : Cela supprimera TOUTES vos donn√©es (bookmakers, paris, tipsters, statistiques). Cette action est irr√©versible. Continuer ?')) {
                if (confirm('√ätes-vous VRAIMENT s√ªr ? Toutes vos donn√©es seront perdues !')) {
                    localStorage.clear();
                    bookmakers = [];
                    operations = [];
                    tipsters = [];
                    saveData();
                    updateSelects();
                    renderBookmakers();
                    renderOperations();
                    renderTipsters();
                    renderStats();
                    alert('‚úÖ Application r√©initialis√©e !');
                }
            }
        }

        function renderStats() {
            const paris = operations.filter(op => op.type === 'Pari');
            const gagnes = paris.filter(p => p.statut === 'Gagn√©').length;
            const perdus = paris.filter(p => p.statut === 'Perdu').length;
            const totalMises = paris.reduce((sum, p) => sum + (p.mise || 0), 0);
            let profit = 0;
            operations.forEach(op => {
                if (op.type === 'Pari') {
                    if (op.statut === 'Gagn√©') profit += (op.mise * op.cote - op.mise);
                    else if (op.statut === 'Perdu') profit -= op.mise;
                    else if (op.statut === 'Cash-out') profit += (op.cashoutAmount - op.mise);
                } else if (op.type === 'Frais') {
                    profit -= op.montant;
                }
            });
            const bankroll = bookmakers.reduce((sum, b) => sum + calcBookmakerBalance(b.id), 0);
            const roi = totalMises > 0 ? ((profit / totalMises) * 100).toFixed(2) : 0;
            const tauxReussite = (gagnes + perdus) > 0 ? ((gagnes / (gagnes + perdus)) * 100).toFixed(2) : 0;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-label">Bankroll Totale</div><div class="stat-value">${bankroll.toFixed(2)}‚Ç¨</div></div>
                <div class="stat-card ${profit >= 0 ? 'green' : 'red'}"><div class="stat-label">Profit/Perte</div><div class="stat-value">${profit >= 0 ? '+' : ''}${profit.toFixed(2)}‚Ç¨</div></div>
                <div class="stat-card"><div class="stat-label">ROI</div><div class="stat-value">${roi}%</div></div>
                <div class="stat-card"><div class="stat-label">Taux de r√©ussite</div><div class="stat-value">${tauxReussite}%</div></div>
                <div class="stat-card green"><div class="stat-label">Paris gagn√©s</div><div class="stat-value">${gagnes}</div></div>
                <div class="stat-card red"><div class="stat-label">Paris perdus</div><div class="stat-value">${perdus}</div></div>
            `;
        }

        function exportData() {
            const data = {
                bookmakers: bookmakers,
                operations: operations,
                tipsters: tipsters,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bankroll-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Donn√©es export√©es avec succ√®s !');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('‚ö†Ô∏è Importer ces donn√©es remplacera toutes vos donn√©es actuelles. Continuer ?')) {
                        bookmakers = data.bookmakers || [];
                        operations = data.operations || [];
                        tipsters = data.tipsters || [];
                        saveData();
                        updateSelects();
                        renderBookmakers();
                        renderOperations();
                        renderTipsters();
                        renderStats();
                        alert('‚úÖ Donn√©es import√©es avec succ√®s !');
                    }
                } catch (err) {
                    alert('‚ùå Erreur lors de l\'importation : fichier invalide');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
    </script>
</body>
</html>
